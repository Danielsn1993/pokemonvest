<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
  <meta name="screen-orientation" content="portrait">
  <meta name="x5-orientation" content="portrait">
  <title>PokemonVest</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Press Start 2P', monospace, Arial;
      background: #000;
      color: #fff;
      font-size: 20px;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
      touch-action: manipulation;
    }

    .container {
      width: 100%;
      max-width: 600px; /* DEFINA O TAMANHO M√ÅXIMO AQUI */
      margin: 0 auto; /* CENTRALIZA */
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .screen {
      position: relative;
      display: none;
      background: #f0f0f0;
      border: 3px solid #000;
      color: #000;
      min-height: 100vh;
      padding: 10px;
    }

    #map-screen {
      padding: 50px 10px 10px 10px;
    }

    .screen.active {
      display: block;
    }

    h1 {
      text-align: center;
      font-size: 32px;
      margin-bottom: 10px;
      color: #ffcc00;
      text-shadow: 2px 2px #000;
    }

    h2 {
      font-size: 24px;
      margin: 10px 0;
      color: #cc0000;
    }

    h3 {
      font-size: 20px;
    }

    .starter-selection {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      gap: 5px;
    }

    .starter-card {
      text-align: center;
      padding: 8px;
      border: 3px solid #333;
      border-radius: 5px;
      background: #f0f0f0;
      flex: 1;
      touch-action: manipulation;
    }

    .starter-card:active {
      transform: scale(0.95);
      border-color: #ffcc00;
      background: #fff;
    }

    .starter-card img {
      width: 60px;
      height: 60px;
    }

    .starter-card p {
      margin-top: 5px;
      font-size: 14px;
      line-height: 1.4;
    }

    .map-container {
      background-image: url('pokemon_assets/images/mapa.png');
      background-size: cover;
      background-position: center;
      border: 3px solid #000;
      border-radius: 5px;
      padding: 10px;
      min-height: 200px;
      position: relative;
    }

    .gym-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .gym-badge {
      background: rgba(255, 255, 255, 0.9);
      border: 3px solid #000;
      border-radius: 5px;
      padding: 8px;
      font-size: 16px;
      touch-action: manipulation;
    }

    .gym-badge:active {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }

    .gym-badge.completed {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border-color: #ff8800;
    }

    .gym-badge.locked {
      opacity: 0.5;
    }

    .pokemon-center-icon {
      width: 150px;
      height: 150px;
      position: static;
      display: block;
      margin: 10px auto;
      transform: scale(1);
      touch-action: manipulation;
      order: 4;
    }

    .pokemon-center-icon:active {
      transform: scale(1.05);
    }

    .player-info {
      background: rgba(0, 0, 0, 0.85);
      border: 3px solid #ffcc00;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
      color: #fff;
      font-size: 18px;
      position: relative;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .player-info > h2 {
      order: 1;
      width: 100%;
    }

    .battle-player-info {
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid #000;
      border-radius: 8px;
      padding: 6px;
      margin-bottom: 8px;
      color: #fff;
      font-size: 12px;
      position: absolute;
      width: 37%;
      height: auto;
      right: 2%;
      bottom: 2%;
    }

    .opponent-info {
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid #000;
      border-radius: 8px;
      padding: 6px;
      color: #fff;
      margin-bottom: 8px;
      font-size: 12px;
      position: absolute;
      width: 45%;
      height: auto;
      left: 2%;
      top: 2%;
    }

    .battle-stat-bar {
      background: #333;
      height: 12px;
      border: 2px solid #000;
      border-radius: 6px;
      overflow: hidden;
      margin: 3px 0;
      max-width: 90%;
    }

    .battle-stat-bar .stat-fill {
      height: 100%;
    }

    .pokemon-display {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px auto;
      justify-content: center;
      order: 2;
    }

    .pokemon-display img.starter-small {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }

    .pokemon-display img.mid-small {
      width: 110px;
      height: 110px;
      flex-shrink: 0;
    }

    .pokemon-display img.final-small {
      width: 150px;
      height: 150px;
      flex-shrink: 0;
    }


    .stats {
      flex: 1;
      text-align: center;
    }

    .stat-bar {
      background: #333;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin: 4px auto; /* MUDE DE "4px 0" PARA "4px auto" - centraliza a barra */
      border: 2px solid #000;
      max-width: 120px;
    }

    .stat-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff00, #00cc00);
      transition: width 0.5s;
    }

    .exp-fill {
      background: linear-gradient(90deg, #4169E1, #1E90FF);
    }

    .potion-container {
      text-align: center;
      margin: 10px 0;
      padding: 8px;
      background: rgba(0, 0, 0, 0.95);
      border: 3px solid #fff;
      border-radius: 5px;
    }

    .potion-container button {
      font-size: 18px;
      min-width: 120px;
    }

    .battle-pokemon-container {
      background-image: url('pokemon_assets/images/battle_bg.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: 3px solid #000;
      border-radius: 5px;
      margin-bottom: 10px;
      position: relative;
      width: 100%;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
      aspect-ratio: 896 / 1152;
      overflow: hidden;
    }

    /* Gin√°sio 0 - Brock (Pewter City) - Pedra */
    .battle-pokemon-container.gym-0 {
      background-image: url('pokemon_assets/images/brock_bg.png');
    }

    /* Gin√°sio 1 - Misty (Cerulean City) - √Ågua */
    .battle-pokemon-container.gym-1 {
      background-image: url('pokemon_assets/images/misty_bg.png');
    }

    /* Gin√°sio 2 - Lt. Surge (Vermilion City) - El√©trico */
    .battle-pokemon-container.gym-2 {
      background-image: url('pokemon_assets/images/ltsurge_bg.png');
    }

    /* Gin√°sio 3 - Erika (Celadon City) - Grama */
    .battle-pokemon-container.gym-3 {
      background-image: url('pokemon_assets/images/erika_bg.png');
    }

    /* Gin√°sio 4 - Koga (Fuchsia City) - Veneno */
    .battle-pokemon-container.gym-4 {
      background-image: url('pokemon_assets/images/koga_bg.png');
    }

    /* Gin√°sio 5 - Sabrina (Saffron City) - Ps√≠quico */
    .battle-pokemon-container.gym-5 {
      background-image: url('pokemon_assets/images/sabrina_bg.png');
    }

    /* Gin√°sio 6 - Blaine (Cinnabar Island) - Fogo */
    .battle-pokemon-container.gym-6 {
      background-image: url('pokemon_assets/images/blaine_bg.png');
    }

    /* Gin√°sio 7 - Giovanni (Viridian City) - Terra */
    .battle-pokemon-container.gym-7 {
      background-image: url('pokemon_assets/images/giovanni_bg.png');
    }

    /* Elite Four - Lorelei (Gelo) */
    .battle-pokemon-container.elite-0 {
      background-image: url('pokemon_assets/images/lorelei_bg.png');
    }

    /* Elite Four - Bruno (Luta) */
    .battle-pokemon-container.elite-1 {
      background-image: url('pokemon_assets/images/bruno_bg.png');
    }

    /* Elite Four - Agatha (Fantasma) */
    .battle-pokemon-container.elite-2 {
      background-image: url('pokemon_assets/images/agatha_bg.png');
    }

    /* Elite Four - Lance (Drag√£o) */
    .battle-pokemon-container.elite-3 {
      background-image: url('pokemon_assets/images/lance_bg.png');
    }

    /* Campe√£o - Ash */
    .battle-pokemon-container.elite-4 {
      background-image: url('pokemon_assets/images/ash_bg.png');
    }

    .pokemon-sprite {
      text-align: center;
      position: absolute;
      width: 37%;
    }

    .player-sprite {
      left: 7%;
      bottom: 0%;
    }

    .opponent-sprite {
      right: 7%;
      top: 35%;
    }

    .pokemon-sprite img {
      width: 60%;      /* ‚Üê Imagem ocupa 60% do container */
      height: auto;    /* ‚Üê Mant√©m propor√ß√£o */
      max-width: 150px; /* ‚Üê Limite m√°ximo */
      object-fit: contain; /* ‚Üê N√£o corta a imagem */
    }

    .question-box {
      background: rgba(0, 0, 0, 0.95);
      border: 3px solid #fff;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 18px;
      color: #fff;
    }

    .question-box h3 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #fff;
      line-height: 1.4;
    }

    .answers {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-top: 8px;
    }

    button {
      background: #ffcc00;
      border: 3px solid #000;
      border-radius: 5px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: 18px;
      color: #000;
      font-weight: bold;
      touch-action: manipulation;
      min-height: 44px;
    }

    button:active {
      background: #ffed4e;
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.5;
    }

    .message-box {
      background: rgba(0, 0, 0, 0.9);
      border: 3px solid #fff;
      border-radius: 5px;
      padding: 10px;
      color: #fff;
      margin: 10px 0;
      min-height: 50px;
      font-size: 18px;
      line-height: 1.5;
    }

    .training-area {
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #000;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 18px;
    }

    .btn-primary {
      background: #cc0000;
      color: #fff;
    }

    .btn-primary:active {
      background: #ff0000;
    }

    .btn-secondary {
      background: #0066cc;
      color: #fff;
    }

    .btn-secondary:active {
      background: #0088ff;
    }

    .btn-reset {
      position: absolute;
      background: #cc0000;
      color: #fff;
      font-size: 14px;
      padding: 6px 8px;
      top: 5px;
      right: 5px;
      min-height: 30px;
    }

    .btn-reset:active {
      background: #ff0000;
    }

    .btn-audio {
      position: absolute;
      background: #0066cc;
      color: #fff;
      font-size: 14px;
      padding: 6px 8px;
      top: 5px;
      right: 95px;
      min-height: 30px;
    }

    .btn-audio:active {
      background: #0088ff;
    }

    .btn-export {
      background: #00aa00;
      color: #fff;
      font-size: 16px;
      padding: 6px 8px;
      position: absolute;
      top: 5px;
      left: 5px;
      min-height: 30px;
    }

    .btn-export:active {
      background: #00cc00;
    }

    .btn-import {
      background: #0066cc;
      color: #fff;
      font-size: 16px;
      padding: 6px 8px;
      position: absolute;
      top: 5px;
      left: 90px;
      min-height: 30px;
    }

    .btn-import:active {
      background: #0088ff;
    }

    .badges-display {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
      justify-content: center;
      order: 3;
    }

    .badge-icon {
      width: 28px;
      height: 28px;
      background: #555;
      border: 2px solid #000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .badge-icon.earned {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
    }

    .elite-section {
      background: rgba(138, 43, 226, 0.9);
      border: 3px solid #ffd700;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      text-align: center;
    }

    .elite-section h2 {
      color: #ffd700;
      font-size: 28px;
      text-shadow: 2px 2px #000;
      margin-bottom: 8px;
    }

    .elite-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .elite-card {
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #000;
      border-radius: 5px;
      padding: 10px;
      font-size: 16px;
      touch-action: manipulation;
    }

    .elite-card:active {
      transform: scale(0.98);
      box-shadow: 0 4px 10px rgba(255, 215, 0, 0.5);
    }

    .elite-card.completed {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border-color: #8b00ff;
    }

    .elite-card.locked {
      opacity: 0.5;
    }

    .victory-screen {
      background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700);
      text-align: center;
      padding: 20px;
    }

    .victory-screen h1 {
      font-size: 40px;
      color: #8b00ff;
      text-shadow: 3px 3px #000;
      margin-bottom: 15px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .victory-screen p {
      font-size: 20px;
      margin: 10px 0;
      color: #000;
    }

    .evolution-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .evolution-overlay.active {
      display: flex;
    }

    .evolution-container {
      text-align: center;
      color: #fff;
      max-width: 90%;
      width: 100%;
      padding: 10px;
    }

    .evolution-container h2 {
      font-size: 28px;
      color: #ffcc00;
      margin-bottom: 15px;
      animation: pulse 1s infinite;
    }

    .evolution-sprites {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
      min-height: 100px;
    }

    .evolution-sprite {
      position: relative;
    }

    .evolution-sprite img {
      width: 80px;
      height: 80px;
    }

    .evolution-arrow {
      font-size: 24px;
      color: #ffcc00;
      animation: slideRight 1s infinite;
    }

    @keyframes slideRight {
      0%, 100% { transform: translateX(-5px); opacity: 0.5; }
      50% { transform: translateX(5px); opacity: 1; }
    }

    .evolution-flash {
      animation: evolutionFlash 0.3s ease-in-out;
    }

    @keyframes evolutionFlash {
      0%, 100% { opacity: 1; filter: brightness(1); }
      50% { opacity: 0.3; filter: brightness(3); }
    }

    .evolution-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .evolution-buttons button {
      min-width: 100px;
      font-size: 18px;
    }

    .battle-result-overlay {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .battle-result-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .battle-result-message {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      border: 5px solid;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
      animation: zoomIn 0.5s ease-out;
      max-width: 90%;
    }

    .battle-result-message.victory {
      border-color: #ffd700;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
    }

    .battle-result-message.defeat {
      border-color: #cc0000;
      box-shadow: 0 0 30px rgba(204, 0, 0, 0.6);
    }

    @keyframes zoomIn {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    .battle-result-message h1 {
      font-size: 40px;
      margin-bottom: 10px;
      text-shadow: 3px 3px #000;
      animation: pulse 2s infinite;
      line-height: 1.3;
    }

    .battle-result-message.victory h1 {
      color: #ffd700;
    }

    .battle-result-message.defeat h1 {
      color: #ff3333;
    }

    .battle-result-message p {
      font-size: 20px;
      color: #fff;
      margin-top: 8px;
      line-height: 1.4;
    }

    .question-counter {
      background: rgba(255, 215, 0, 0.9);
      border: 2px solid #000;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 16px;
      color: #000;
      font-weight: bold;
      display: inline-block;
      margin-bottom: 8px;
    }

    .image-preview {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.95);
      padding: 0;
      box-shadow: none;
      border: none;
      border-radius: 0;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      margin: 0;
    }

    .image-preview.active {
      display: block;
    }

    .image-link {
      color: #ffcc00;
      text-decoration: underline;
      margin-bottom: 10px;
      display: inline-block;
      font-size: 24px;
      touch-action: manipulation;
    }

    .image-link:active {
      color: #fff;
    }

    /* Mini-game Modal */
    .minigame-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      height: 600px;
      background: linear-gradient(135deg, #001F3F, #003366);
      border: 5px solid #000;
      border-radius: 15px;
      padding: 20px;
      z-index: 10000;
      display: none;
      flex-direction: column;
      align-items: center;
    }

    .minigame-modal.active {
      display: flex;
    }

    .minigame-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      display: none;
    }

    .minigame-overlay.active {
      display: block;
    }

    .minigame-header {
      text-align: center;
      margin-bottom: 10px;
    }

    .minigame-header h2 {
      color: #fff;
      text-shadow: 2px 2px #000;
      font-size: 20px;
    }

    .minigame-timer {
      font-size: 24px;
      color: #ff0000;
      margin: 5px 0;
    }

    .minigame-timer.countdown-mode {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 108px;
      z-index: 1000;
      background: none;
      padding: 0;
      border-radius: 0;
      border: none;
      color: #FFD700;
    }

    .minigame-score {
      font-size: 25px;
      color: white;
    }

    .minigame-area {
      position: relative;
      width: 100%;
      flex: 1;
      background: rgba(255, 255, 255, 0.2);
      border: 3px solid #000;
      border-radius: 10px;
      overflow: hidden;
    }

    .basket {
      position: absolute;
      bottom: 20px;
      width: 80px;
      height: 60px;
      background: #8B4513;
      border: 3px solid #000;
      border-radius: 10px 10px 40px 40px;
      transition: left 0.1s;
    }

    .pokeball-falling {
      position: absolute;
      width: 40px;
      height: 40px;
      background: transparent; /* Removido o fundo vermelho */
      border: none; /* Removida a borda */
      border-radius: 50%;
      animation: fall linear;
      font-size: 30px; /* Tamanho do emoji */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fall {
      to {
        transform: translateY(600px);
      }
    }

    .minigame-result {
      text-align: center;
      padding: 20px;
      display: none;
    }

    .minigame-result.show {
      display: block;
    }

    .minigame-btn {
      padding: 15px 30px;
      font-size: 16px;
      background: #ffcc00;
      border: 3px solid #000;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    .explanation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .explanation-modal.active {
      display: flex;
    }

    .explanation-content {
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      border: 5px solid #ffcc00;
      border-radius: 10px;
      width: 75vw;
      height: 75vh;
      max-width: 75vw;
      max-height: 75vh;
      overflow-y: auto;
      padding: 20px;
      position: relative;
      color: #fff;
    }

    .close-explanation {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #cc0000;
      color: #fff;
      border: 2px solid #000;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      touch-action: manipulation;
    }

    .close-explanation:active {
      background: #ff0000;
      transform: scale(1.1);
    }

    .explanation-content h2 {
      color: #ffcc00;
      margin-bottom: 15px;
      font-size: 24px;
    }

    #explanation-text {
      font-size: 18px;
      line-height: 1.6;
      color: #fff;
    }

    /* Menu do Pokemon Center */
    .pokemon-center-menu {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9998;
      justify-content: center;
      align-items: center;
    }

    .pokemon-center-menu.active {
      display: flex;
    }

    .menu-content {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      border: 5px solid #fff;
      border-radius: 15px;
      padding: 25px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
      animation: menuAppear 0.3s ease-out;
    }

    @keyframes menuAppear {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .menu-content h2 {
      color: #fff;
      text-align: center;
      font-size: 24px;
      margin-bottom: 20px;
      text-shadow: 2px 2px #000;
    }

    .menu-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .menu-option-btn {
      background: linear-gradient(135deg, #ffcc00, #ffed4e);
      border: 3px solid #000;
      border-radius: 8px;
      padding: 15px;
      font-family: inherit;
      font-size: 18px;
      color: #000;
      font-weight: bold;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
      touch-action: manipulation;
      min-height: 60px;
      transition: transform 0.1s;
    }

    .menu-option-btn:active {
      background: linear-gradient(135deg, #ffed4e, #ffcc00);
      transform: scale(0.98);
    }

    .menu-option-btn:disabled {
      opacity: 0.5;
      background: #999;
    }

    .menu-option-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .menu-option-text {
      flex: 1;
    }

    .menu-option-text small {
      display: block;
      font-size: 14px;
      margin-top: 3px;
      opacity: 0.8;
    }

    .menu-close-btn {
      background: #cc0000;
      color: #fff;
      margin-top: 10px;
      font-size: 16px;
      padding: 12px;
      text-align: center;
    }

    .menu-close-btn:active {
      background: #ff0000;
    }

  </style>
</head>
<body>
  <div id="image-preview" class="image-preview" onclick="hideImagePreview()">
    <img id="preview-img" src="" alt="Preview">
  </div>

  <div id="explanation-modal" class="explanation-modal" onclick="closeExplanationModal()">
    <div class="explanation-content" onclick="event.stopPropagation()">
      <div class="close-explanation" onclick="closeExplanationModal()">‚úï</div>
      <h2>üìñ EXPLICA√á√ÉO</h2>
      <div id="explanation-text"></div>
    </div>
  </div>

  <div id="battle-result-overlay" class="battle-result-overlay">
    <div id="battle-result-message" class="battle-result-message">
      <h1 id="battle-result-title"></h1>
      <p id="battle-result-text"></p>
    </div>
  </div>

  <div id="evolution-overlay" class="evolution-overlay">
    <div class="evolution-container">
      <h2 id="evolution-title">O QU√ä?</h2>
      <div class="evolution-sprites">
        <div class="evolution-sprite">
          <img id="evolution-from-sprite" src="" alt="Pokemon Atual">
          <p id="evolution-from-name" style="margin-top: 8px; font-size: 18px;"></p>
        </div>
        <div class="evolution-arrow">‚ûú</div>
        <div class="evolution-sprite">
          <img id="evolution-to-sprite" src="" alt="Pokemon Evolu√≠do">
          <p id="evolution-to-name" style="margin-top: 8px; font-size: 18px;"></p>
        </div>
      </div>
      <p id="evolution-message" style="font-size: 18px; margin: 10px 0;"></p>
      <div class="evolution-buttons" id="evolution-choice" style="display: none;">
        <button onclick="confirmEvolution()" class="btn-primary">Sim, evoluir!</button>
        <button onclick="cancelEvolution()" class="btn-secondary">N√£o, cancelar</button>
      </div>
    </div>
  </div>

  <audio id="map-music" loop preload="auto">
    <source src="pokemon_assets/audio/music1.mp3" type="audio/mpeg">
  </audio>
  <audio id="training-music" loop preload="auto">
    <source src="pokemon_assets/audio/music2.mp3" type="audio/mpeg">
  </audio>
  <audio id="gym-music" loop preload="auto">
    <source src="pokemon_assets/audio/music3.mp3" type="audio/mpeg">
  </audio>
  <audio id="elite-music" loop preload="auto">
    <source src="pokemon_assets/audio/music4.mp3" type="audio/mpeg">
  </audio>

  <!-- Menu do Pokemon Center -->
  <div id="pokemon-center-menu" class="pokemon-center-menu">
    <div class="menu-content">
      <h2>üíä POK√âMON CENTER üíä</h2>
      <div class="menu-options">
        <button class="menu-option-btn" onclick="healPokemonFromMenu()">
          <span class="menu-option-icon">‚ù§Ô∏è</span>
          <div class="menu-option-text">
            <strong>Curar Pok√©mon</strong>
            <small>Restaura o HP completamente</small>
          </div>
        </button>
        
        <button class="menu-option-btn" id="potion-minigame-btn" onclick="startPotionMinigame()">
          <span class="menu-option-icon">üß™</span>
          <div class="menu-option-text">
            <strong>Conseguir Po√ß√µes</strong>
            <small>Jogue o minigame (apenas com 0 po√ß√µes)</small>
          </div>
        </button>
      </div>
      
      <button class="menu-option-btn menu-close-btn" onclick="closePokemonCenterMenu()">
        ‚úï Fechar
      </button>
    </div>
  </div>

  <div class="container">
    <div id="starter-screen" class="screen">
      <h1>üéÆ POKEMONVEST üéÆ</h1>
      <h2>Escolha seu Pokemon Inicial:</h2>
      <div class="starter-selection">
        <div class="starter-card" onclick="selectStarter('bulbasaur')">
          <img src="pokemon_assets/sprites_front/bulbasaur.gif" alt="Bulbasaur">
          <p><strong>BULBASAUR</strong><br>Tipo: Grama/Venenoso</p>
        </div>
        <div class="starter-card" onclick="selectStarter('charmander')">
          <img src="pokemon_assets/sprites_front/charmander.gif" alt="Charmander">
          <p><strong>CHARMANDER</strong><br>Tipo: Fogo</p>
        </div>
        <div class="starter-card" onclick="selectStarter('squirtle')">
          <img src="pokemon_assets/sprites_front/squirtle.gif" alt="Squirtle">
          <p><strong>SQUIRTLE</strong><br>Tipo: √Ågua</p>
        </div>
      </div>
    </div>

    <div id="map-screen" class="screen">
      <button onclick="resetGameAndTrophies()" class="btn-reset">Resetar</button>
      <button onclick="toggleAudio()" class="btn-audio" id="audio-toggle-btn">üîä</button>
      <button onclick="exportSave()" class="btn-export">üíæ Save</button>
      <button onclick="importSave()" class="btn-import">üìÅ Load</button>
      <input type="file" id="file-input" accept=".txt" style="display: none;" onchange="loadSaveFile(event)">
      <h1>üó∫Ô∏è MAPA DE KANTO üó∫Ô∏è</h1>
      
      <div class="player-info">
        <h2>üèÜ Trof√©us: <span id="trophy-count">0</span></h2>
        <h2>üß™ Po√ß√µes: <span id="potion-count">0</span>/2</h2>
        <div class="pokemon-display">
          <img id="player-sprite" src="" alt="Seu Pokemon">
          <div class="stats">
            <p><strong id="player-pokemon-name">---</strong> - N√≠vel <span id="player-level">1</span></p>
            <div class="stat-bar">
              <div class="stat-fill" id="hp-bar" style="width: 100%"></div>
            </div>
            <p>HP: <span id="hp-display">15/15</span></p>
            <div class="stat-bar">
              <div class="stat-fill exp-fill" id="exp-bar" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="exp-display">0/50</span></p>
          </div>
        </div>

        <img src="pokemon_assets/images/pokemon_center.png" 
            alt="Pokemon Center" 
            class="pokemon-center-icon" 
            onclick="openPokemonCenterMenu()"
            title="Clique para abrir o Pokemon Center">

        <div class="badges-display">
          <div class="badge-icon" id="badge-0" title="Boulder Badge">ü™®</div>
          <div class="badge-icon" id="badge-1" title="Cascade Badge">üíß</div>
          <div class="badge-icon" id="badge-2" title="Thunder Badge">‚ö°</div>
          <div class="badge-icon" id="badge-3" title="Rainbow Badge">üåà</div>
          <div class="badge-icon" id="badge-4" title="Soul Badge">‚ò†Ô∏è</div>
          <div class="badge-icon" id="badge-5" title="Marsh Badge">üß†</div>
          <div class="badge-icon" id="badge-6" title="Volcano Badge">üî•</div>
          <div class="badge-icon" id="badge-7" title="Earth Badge">üåç</div>
        </div>
      </div>

      <div class="training-area">
        <h2>üí™ √Årea de Treino</h2>
        <p style="margin: 8px 0;">Resolva quest√µes para causar dano ao pokemon inimigo, ganhar EXP e subir de n√≠vel! Cuidado: erros fazem voc√™ perder vida (HP) em batalhas.</p>
        <button onclick="startTraining()" class="btn-secondary">Treinar Agora</button>
      </div>

      <h2 style="margin-top: 10px; text-align: center;">GIN√ÅSIOS DE KANTO</h2>
      <div class="gym-grid">
        <div class="gym-badge" id="gym-0" onclick="challengeGym(0)">
          <h3>ü™® PEWTER CITY</h3>
          <p style="margin-top: 5px;">L√≠der: Brock<br>N√≠vel Recomendado: 10</p>
        </div>
        <div class="gym-badge locked" id="gym-1" onclick="challengeGym(1)">
          <h3>üíß CERULEAN CITY</h3>
          <p style="margin-top: 5px;">L√≠der: Misty<br>N√≠vel Recomendado: 18</p>
        </div>
        <div class="gym-badge locked" id="gym-2" onclick="challengeGym(2)">
          <h3>‚ö° VERMILION CITY</h3>
          <p style="margin-top: 5px;">L√≠der: Lt. Surge<br>N√≠vel Recomendado: 25</p>
        </div>
        <div class="gym-badge locked" id="gym-3" onclick="challengeGym(3)">
          <h3>üåà CELADON CITY</h3>
          <p style="margin-top: 5px;">L√≠der: Erika<br>N√≠vel Recomendado: 30</p>
        </div>
        <div class="gym-badge locked" id="gym-4" onclick="challengeGym(4)">
          <h3>‚ò†Ô∏è FUCHSIA CITY</h3>
          <p style="margin-top: 5px;">L√≠der: Koga<br>N√≠vel Recomendado: 35</p>
        </div>
        <div class="gym-badge locked" id="gym-5" onclick="challengeGym(5)">
          <h3>üß† SAFFRON CITY</h3>
          <p style="margin-top: 5px;">L√≠der: Sabrina<br>N√≠vel Recomendado: 38</p>
        </div>
        <div class="gym-badge locked" id="gym-6" onclick="challengeGym(6)">
          <h3>üî• CINNABAR ISLAND</h3>
          <p style="margin-top: 5px;">L√≠der: Blaine<br>N√≠vel Recomendado: 42</p>
        </div>
        <div class="gym-badge locked" id="gym-7" onclick="challengeGym(7)">
          <h3>üåç VIRIDIAN CITY</h3>
          <p style="margin-top: 5px;">L√≠der: Giovanni<br>N√≠vel Recomendado: 45</p>
        </div>
      </div>

      <div class="elite-section" id="elite-section" style="display: none;">
        <h2>üëë ELITE FOUR üëë</h2>
        <p style="font-size: 18px; color: #fff; margin: 10px 0;">Voc√™ conquistou todas as 8 ins√≠gnias!<br>Agora enfrente a Elite Four!</p>
        <div class="elite-grid">
          <div class="elite-card locked" id="elite-0" onclick="challengeElite(0)">
            <h3>‚ùÑÔ∏è LORELEI</h3>
            <p style="margin-top: 5px;">Elite Four #1<br>Mestre de Gelo<br>N√≠vel Recomendado: 50</p>
          </div>
          <div class="elite-card locked" id="elite-1" onclick="challengeElite(1)">
            <h3>üëä BRUNO</h3>
            <p style="margin-top: 5px;">Elite Four #2<br>Mestre de Luta<br>N√≠vel Recomendado: 55</p>
          </div>
          <div class="elite-card locked" id="elite-2" onclick="challengeElite(2)">
            <h3>üëª AGATHA</h3>
            <p style="margin-top: 5px;">Elite Four #3<br>Mestre Fantasma<br>N√≠vel Recomendado: 60</p>
          </div>
          <div class="elite-card locked" id="elite-3" onclick="challengeElite(3)">
            <h3>üêâ LANCE</h3>
            <p style="margin-top: 5px;">Elite Four #4<br>Mestre de Drag√µes<br>N√≠vel Recomendado: 75</p>
          </div>
          <div class="elite-card locked" id="elite-4" onclick="challengeElite(4)" style="grid-column: 1 / -1;">
            <h3>üèÜ ASH (CAMPE√ÉO)</h3>
            <p style="margin-top: 5px;">Batalha Final<br>Ash<br>N√≠vel Recomendado: 100</p>
          </div>
        </div>
      </div>
    </div>

    <div id="training-screen" class="screen">
      <h1>üí™ TREINO POKEMON üí™</h1>
      
      <div class="battle-pokemon-container">
          <div class="opponent-info">
            <p><strong id="training-opponent-name">Pokemon Selvagem</strong></p>
            <p><span id="training-opponent-pokemon-name">Pokemon</span> - N√≠vel <span id="training-opponent-level">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="training-opponent-hp-bar" style="width: 100%"></div>
            </div>
            <p>HP: <span id="training-opponent-hp-display">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="training-player-sprite" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="training-opponent-sprite" src="" alt="Pokemon Selvagem">
          </div>

          <div class="battle-player-info">
            <p><span id="training-pokemon-name">---</span> Lv.<span id="training-level">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="training-battle-hp-bar" style="width: 100%"></div>
            </div>
            <p>HP: <span id="training-battle-hp-display">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="training-exp-bar" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="training-exp-display">0/50</span></p>
          </div>
      </div>

      <div class="message-box" id="training-message">
        Responda corretamente para atacar o Pokemon selvagem!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('training')" id="training-potion-btn">
          üß™ Usar Po√ß√£o (<span id="training-potion-count">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="training-counter">Quest√µes: 0/0</div>
        <h3 id="training-question">Carregando quest√£o...</h3>
        <div class="answers" id="training-answers"></div>
      </div>

      <div style="text-align: center;">
        <button onclick="backToMap()" class="btn-secondary">Voltar ao Mapa</button>
      </div>
    </div>

    <!-- GIN√ÅSIO 0 - BROCK -->
    <div id="battle-screen-gym-0" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container gym-0">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-gym-0">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-gym-0">Pokemon</span> - N√≠vel <span id="opponent-level-gym-0">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-gym-0" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-gym-0">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-gym-0" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-gym-0" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-gym-0">---</span> Lv.<span id="battle-player-level-gym-0">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-gym-0" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-gym-0">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-gym-0" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-gym-0">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-gym-0">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'gym-0')" id="battle-potion-btn-gym-0">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-gym-0">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-gym-0">Quest√µes: 0/0</div>
        <h3 id="battle-question-gym-0">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-gym-0"></div>
      </div>
    </div>

    <!-- GIN√ÅSIO 1 - MISTY -->
    <div id="battle-screen-gym-1" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container gym-1">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-gym-1">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-gym-1">Pokemon</span> - N√≠vel <span id="opponent-level-gym-1">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-gym-1" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-gym-1">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-gym-1" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-gym-1" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-gym-1">---</span> Lv.<span id="battle-player-level-gym-1">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-gym-1" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-gym-1">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-gym-1" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-gym-1">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-gym-1">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'gym-1')" id="battle-potion-btn-gym-1">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-gym-1">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-gym-1">Quest√µes: 0/0</div>
        <h3 id="battle-question-gym-1">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-gym-1"></div>
      </div>
    </div>

    <!-- GIN√ÅSIO 2 - LT. SURGE -->
    <div id="battle-screen-gym-2" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container gym-2">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-gym-2">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-gym-2">Pokemon</span> - N√≠vel <span id="opponent-level-gym-2">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-gym-2" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-gym-2">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-gym-2" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-gym-2" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-gym-2">---</span> Lv.<span id="battle-player-level-gym-2">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-gym-2" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-gym-2">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-gym-2" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-gym-2">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-gym-2">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'gym-2')" id="battle-potion-btn-gym-2">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-gym-2">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-gym-2">Quest√µes: 0/0</div>
        <h3 id="battle-question-gym-2">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-gym-2"></div>
      </div>
    </div>

    <!-- GIN√ÅSIO 3 - ERIKA -->
    <div id="battle-screen-gym-3" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container gym-3">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-gym-3">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-gym-3">Pokemon</span> - N√≠vel <span id="opponent-level-gym-3">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-gym-3" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-gym-3">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-gym-3" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-gym-3" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-gym-3">---</span> Lv.<span id="battle-player-level-gym-3">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-gym-3" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-gym-3">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-gym-3" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-gym-3">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-gym-3">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'gym-3')" id="battle-potion-btn-gym-3">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-gym-3">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-gym-3">Quest√µes: 0/0</div>
        <h3 id="battle-question-gym-3">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-gym-3"></div>
      </div>
    </div>

    <!-- GIN√ÅSIO 4 - KOGA -->
    <div id="battle-screen-gym-4" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container gym-4">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-gym-4">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-gym-4">Pokemon</span> - N√≠vel <span id="opponent-level-gym-4">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-gym-4" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-gym-4">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-gym-4" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-gym-4" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-gym-4">---</span> Lv.<span id="battle-player-level-gym-4">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-gym-4" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-gym-4">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-gym-4" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-gym-4">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-gym-4">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'gym-4')" id="battle-potion-btn-gym-4">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-gym-4">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-gym-4">Quest√µes: 0/0</div>
        <h3 id="battle-question-gym-4">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-gym-4"></div>
      </div>
    </div>

    <!-- GIN√ÅSIO 5 - SABRINA -->
    <div id="battle-screen-gym-5" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container gym-5">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-gym-5">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-gym-5">Pokemon</span> - N√≠vel <span id="opponent-level-gym-5">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-gym-5" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-gym-5">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-gym-5" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-gym-5" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-gym-5">---</span> Lv.<span id="battle-player-level-gym-5">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-gym-5" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-gym-5">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-gym-5" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-gym-5">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-gym-5">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'gym-5')" id="battle-potion-btn-gym-5">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-gym-5">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-gym-5">Quest√µes: 0/0</div>
        <h3 id="battle-question-gym-5">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-gym-5"></div>
      </div>
    </div>

    <!-- GIN√ÅSIO 6 - BLAINE -->
    <div id="battle-screen-gym-6" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container gym-6">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-gym-6">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-gym-6">Pokemon</span> - N√≠vel <span id="opponent-level-gym-6">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-gym-6" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-gym-6">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-gym-6" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-gym-6" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-gym-6">---</span> Lv.<span id="battle-player-level-gym-6">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-gym-6" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-gym-6">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-gym-6" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-gym-6">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-gym-6">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'gym-6')" id="battle-potion-btn-gym-6">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-gym-6">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-gym-6">Quest√µes: 0/0</div>
        <h3 id="battle-question-gym-6">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-gym-6"></div>
      </div>
    </div>

    <!-- GIN√ÅSIO 7 - GIOVANNI -->
    <div id="battle-screen-gym-7" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container gym-7">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-gym-7">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-gym-7">Pokemon</span> - N√≠vel <span id="opponent-level-gym-7">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-gym-7" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-gym-7">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-gym-7" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-gym-7" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-gym-7">---</span> Lv.<span id="battle-player-level-gym-7">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-gym-7" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-gym-7">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-gym-7" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-gym-7">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-gym-7">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'gym-7')" id="battle-potion-btn-gym-7">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-gym-7">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-gym-7">Quest√µes: 0/0</div>
        <h3 id="battle-question-gym-7">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-gym-7"></div>
      </div>
    </div>

    <!-- ELITE 0 - LORELEI -->
    <div id="battle-screen-elite-0" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container elite-0">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-elite-0">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-elite-0">Pokemon</span> - N√≠vel <span id="opponent-level-elite-0">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-elite-0" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-elite-0">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-elite-0" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-elite-0" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-elite-0">---</span> Lv.<span id="battle-player-level-elite-0">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-elite-0" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-elite-0">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-elite-0" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-elite-0">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-elite-0">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'elite-0')" id="battle-potion-btn-elite-0">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-elite-0">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-elite-0">Quest√µes: 0/0</div>
        <h3 id="battle-question-elite-0">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-elite-0"></div>
      </div>
    </div>

    <!-- ELITE 1 - BRUNO -->
    <div id="battle-screen-elite-1" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container elite-1">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-elite-1">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-elite-1">Pokemon</span> - N√≠vel <span id="opponent-level-elite-1">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-elite-1" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-elite-1">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-elite-1" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-elite-1" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-elite-1">---</span> Lv.<span id="battle-player-level-elite-1">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-elite-1" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-elite-1">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-elite-1" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-elite-1">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-elite-1">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'elite-1')" id="battle-potion-btn-elite-1">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-elite-1">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-elite-1">Quest√µes: 0/0</div>
        <h3 id="battle-question-elite-1">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-elite-1"></div>
      </div>
    </div>

    <!-- ELITE 2 - AGATHA -->
    <div id="battle-screen-elite-2" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container elite-2">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-elite-2">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-elite-2">Pokemon</span> - N√≠vel <span id="opponent-level-elite-2">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-elite-2" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-elite-2">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-elite-2" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-elite-2" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-elite-2">---</span> Lv.<span id="battle-player-level-elite-2">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-elite-2" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-elite-2">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-elite-2" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-elite-2">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-elite-2">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'elite-2')" id="battle-potion-btn-elite-2">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-elite-2">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-elite-2">Quest√µes: 0/0</div>
        <h3 id="battle-question-elite-2">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-elite-2"></div>
      </div>
    </div>

    <!-- ELITE 3 - LANCE -->
    <div id="battle-screen-elite-3" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container elite-3">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-elite-3">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-elite-3">Pokemon</span> - N√≠vel <span id="opponent-level-elite-3">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-elite-3" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-elite-3">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-elite-3" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-elite-3" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-elite-3">---</span> Lv.<span id="battle-player-level-elite-3">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-elite-3" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-elite-3">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-elite-3" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-elite-3">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-elite-3">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'elite-3')" id="battle-potion-btn-elite-3">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-elite-3">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-elite-3">Quest√µes: 0/0</div>
        <h3 id="battle-question-elite-3">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-elite-3"></div>
      </div>
    </div>

    <!-- ELITE 4 - ASH (CAMPE√ÉO) -->
    <div id="battle-screen-elite-4" class="screen">
      <h1>‚öîÔ∏è BATALHA POKEMON ‚öîÔ∏è</h1>
      
      <div class="battle-pokemon-container elite-4">
        <div class="battle-area">
          <div class="opponent-info">
            <p><strong id="opponent-name-elite-4">Pokemon</strong></p>
            <p><span id="opponent-pokemon-name-elite-4">Pokemon</span> - N√≠vel <span id="opponent-level-elite-4">5</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="opponent-hp-bar-elite-4" style="width: 100%"></div>
            </div>
            <p>HP: <span id="opponent-hp-display-elite-4">30/30</span></p>
          </div>

          <div class="pokemon-sprite player-sprite">
            <img id="battle-player-sprite-elite-4" src="" alt="Seu Pokemon">
          </div>
          <div class="pokemon-sprite opponent-sprite">
            <img id="battle-opponent-sprite-elite-4" src="" alt="Pokemon">
          </div>

          <div class="battle-player-info">
            <p><span id="battle-player-name-elite-4">---</span> Lv.<span id="battle-player-level-elite-4">1</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill" id="battle-hp-bar-elite-4" style="width: 100%"></div>
            </div>
            <p>HP: <span id="battle-hp-display-elite-4">15/15</span></p>
            <div class="battle-stat-bar">
              <div class="stat-fill exp-fill" id="battle-exp-bar-elite-4" style="width: 0%"></div>
            </div>
            <p>EXP: <span id="battle-exp-display-elite-4">0/50</span></p>
          </div>
        </div>
      </div>

      <div class="message-box" id="battle-message-elite-4">
        Responda corretamente para atacar o pokemon do l√≠der do gin√°sio!
      </div>

      <div class="potion-container">
        <button onclick="usePotion('battle', 'elite-4')" id="battle-potion-btn-elite-4">
          üß™ Usar Po√ß√£o (<span id="battle-potion-count-elite-4">0</span>)
        </button>
      </div>

      <div class="question-box">
        <div class="question-counter" id="battle-counter-elite-4">Quest√µes: 0/0</div>
        <h3 id="battle-question-elite-4">Carregando quest√£o...</h3>
        <div class="answers" id="battle-answers-elite-4"></div>
      </div>
    </div>

    <div id="victory-screen" class="screen victory-screen">
      <h1>üéâ PARAB√âNS! üéâ</h1>
      <p style="font-size: 24px; margin: 15px 0;">VOC√ä SE TORNOU O</p>
      <h1 style="font-size: 44px;">MESTRE POKEMON!</h1>
      <p style="font-size: 20px; margin: 15px 0;">Voc√™ derrotou todos os l√≠deres de gin√°sio<br>e a Elite Four!</p>
      <p style="font-size: 24px; margin: 20px 0;">üèÜ JOGO COMPLETO üèÜ</p>
      <button onclick="resetGame()" style="font-size: 20px; margin-top: 15px;">Jogar Novamente</button>
    </div>
  </div>

  <!-- Mini-game Modal -->
  <div class="minigame-overlay" id="minigame-overlay"></div>
  <div class="minigame-modal" id="minigame-modal">
    <div class="minigame-header">
      <h2>Captura de Po√ß√µes!</h2>
      <div class="minigame-timer">
        ITENS TOTAIS: <span id="minigame-time">50</span>
      </div>
      <div class="minigame-score">Po√ß√µes: <span id="minigame-caught">0</span>/30</div>
    </div>
    
    <div class="minigame-area" id="minigame-area">
      <div class="basket" id="basket"></div>
    </div>
    
    <div class="minigame-result" id="minigame-result">
      <h3 id="result-title"></h3>
      <p id="result-message"></p>
      <button class="minigame-btn" onclick="closeMinigame()">Continuar</button>
    </div>
  </div>

  <script>
    const game = {
      player: {
        pokemon: null,
        level: 1,
        exp: 0,
        expToNext: 50,
        maxHp: 15,
        hp: 15,
        badges: [],
        eliteDefeated: [],
        potions: 0,
        trophies: 0
      },
      currentGym: null,
      currentElite: null,
      currentOpponent: null,
      inBattle: false,
      battleType: 'gym',
      trainingOpponent: null,
      questionsAnswered: 0,
      pendingEvolution: null
    };

    let currentBattleSuffix = '';

    // Vari√°veis do mini-game
    let minigameActive = false;
    let minigameTimer = null;
    let minigamePokeballInterval = null;
    let minigameTimeLeft = 10;
    let minigameCaught = 0;
    let minigameTotalBalls = 50;
    let minigameBasketPosition = 50;
    const MAX_POTIONS = 2;

    /**
     * Calcula a porcentagem de dano baseada na diferen√ßa de n√≠vel
     * @param {number} attackerLevel - N√≠vel do atacante
     * @param {number} defenderLevel - N√≠vel do defensor
     * @returns {object} - {min: porcentagem m√≠nima, max: porcentagem m√°xima}
     */
    function calculateDamagePercent(attackerLevel, defenderLevel) {
      const BASE = 0.27;           // 27% de dano base
      const VARIANCE = 0.01;        // ¬±1% para fator sorte
      const BONUS_PER_LEVEL = 0.01; // 1% por n√≠vel de diferen√ßa
      const MIN_DAMAGE = 0.10;      // Limitador m√≠nimo: 10%
      const MAX_DAMAGE = 0.80;      // Limitador m√°ximo: 80%
      
      // Calcula diferen√ßa de n√≠vel (pode ser positivo ou negativo)
      const levelDiff = attackerLevel - defenderLevel;
      
      // Calcula o b√¥nus/penalidade
      const bonus = levelDiff * BONUS_PER_LEVEL;
      
      // Aplica o b√¥nus aos valores base
      let minPercent = BASE - VARIANCE + bonus;
      let maxPercent = BASE + VARIANCE + bonus;
      
      // Aplica os limitadores
      minPercent = Math.max(MIN_DAMAGE, Math.min(MAX_DAMAGE, minPercent));
      maxPercent = Math.max(MIN_DAMAGE + 0.02, Math.min(MAX_DAMAGE + 0.02, maxPercent));
      
      return { min: minPercent, max: maxPercent };
    }

    const audioSystem = {
      currentAudio: null,
      fadeInDuration: 2000,
      
      stopAll() {
        const audios = ['map-music', 'training-music', 'gym-music', 'elite-music'];
        audios.forEach(id => {
          const audio = document.getElementById(id);
          audio.pause();
          audio.currentTime = 0;
          audio.volume = 0;
        });
        this.currentAudio = null;
      },
      
      play(audioId) {
        if (this.currentAudio === audioId) return;
        this.stopAll();
        const audio = document.getElementById(audioId);
        audio.volume = 0;
        audio.play().catch(e => console.log('Erro ao reproduzir √°udio:', e));
        this.currentAudio = audioId;
        this.fadeIn(audio);
      },
      
      fadeIn(audio) {
        const steps = 20;
        const volumeIncrement = 1 / steps;
        const timeIncrement = this.fadeInDuration / steps;
        let currentStep = 0;
        
        const fadeInterval = setInterval(() => {
          currentStep++;
          audio.volume = Math.min(currentStep * volumeIncrement, 1);
          if (currentStep >= steps) clearInterval(fadeInterval);
        }, timeIncrement);
      }
    };

    function showBattleResult(isVictory, title, subtitle) {
      const overlay = document.getElementById('battle-result-overlay');
      const message = document.getElementById('battle-result-message');
      const titleEl = document.getElementById('battle-result-title');
      const textEl = document.getElementById('battle-result-text');
      
      message.className = 'battle-result-message ' + (isVictory ? 'victory' : 'defeat');
      titleEl.textContent = title;
      textEl.textContent = subtitle;
      
      overlay.classList.add('active');
      
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 3000);
    }

    const rawQuestionsText = `

QUEST√ÉO 1

√â correto afirmar que os raios cat√≥dicos s√£o constitu√≠dos de:

A) El√©trons.
B) Pr√≥tons.
C) √Çnions.
D) C√°tions.
E) N√™utrons.

EXPLICA√á√ÉO: No experimento de Thomson, os raios cat√≥dicos se desviavam para a placa positiva, levando a interpreta√ß√£o de que os raio s√£o constiu√≠dos por part√≠culas negativas. Na qu√≠mica, as part√≠culas com carga negativa s√£o conhecidas por el√©trons.

GABARITO: A

QUEST√ÉO 2

O modelo at√¥mico capaz de explicar o funcionamento da l√¢mpada fluorescente √©:

A) Modelo de Dalton.
B) Modelo de Thomson.
C) Modelo de Rutherford.
D) Modelo de Bohr.
E) Modelo de Lewis.

EXPLICA√á√ÉO: Segundo o modelo de Bohr, o el√©tron, ao absorver uma quantidade bem definida de energia, salta par aum n√≠vel mais energ√©tico, passando para o estado excitado. Ao perder energia que ganhou, retorna ao seu estado fundamental, emitindo energia em forma de luz (funcionamento da l√¢mpada fluorescente).

GABARITO: D

QUEST√ÉO 3

Assinale a alternativa na qual a afirma√ß√£o do modelo at√¥mico de Dalton n√£o esteja de acordo com a exist√™ncia dos is√≥topos:

A) Cada elemento √© composto por √°tomos.
B) Todos os √°tomos de um mesmo elemento s√£o id√™nticos.
C) Nas rea√ß√µes qu√≠micas os √°tomos n√£o s√£o alterados.
D) Os compostos s√£o formados quando √°tomos de mais de um elemento se combinam.
E) Se uma massa fixa de um elemento se combina com massas diferentes de um segundo elemento, essas massas relacionam-se entre s√≠ atrav√©s de n√∫meros pequenos inteiros.

EXPLICA√á√ÉO: 

GABARITO: B

QUEST√ÉO 4

Em 1803, John Dalton prop√¥s um modelo de teoria at√¥mica. Considere que sobre a base conceitual desse modelo sejam feitas as seguintes afirma√ß√µes: I - O √°tomo apresenta a configura√ß√£o de uma esfera r√≠gida. II - Os √°tomos caracterizam os elementos qu√≠micos e somente os √°tomos de um mesmo elemento s√£o id√™nticos em todos os aspectos. III - As transforma√ß√µes qu√≠micas consistem de combina√ß√£o, separa√ß√£o e/ou rearranjo de √°tomos. IV - Compostos qu√≠micos s√£o formados de √°tomos de dois ou mais elementos unidos em uma raz√£o fixa. Qual das op√ß√µes a seguir se refere a todas afirma√ß√µes CORRETAS?

A) I e IV.
B) II e III.
C) II e IV.
D) II, III e IV.
E) I, II, III e IV.

EXPLICA√á√ÉO: 

GABARITO: E

QUEST√ÉO 5

Qual dos postulados abaixo de Dalton ainda √© considerado correto?

A) A mat√©ria √© constitu√≠da de √°tomos indivis√≠veis.
B) Todos os √°tomos de um dado elemento qu√≠mico s√£o id√™nticos em massa e em todas as outras propriedades.
C) Diferentes elementos qu√≠micos t√™m diferentes tipos de √°tomos; em particular, seus √°tomos t√™m diferentes massas.
D) Os √°tomos s√£o indestrut√≠veis e nas rea√ß√µes qu√≠micas mant√™m suas identidades.
E) √Åtomos de elementos combinam com √°tomos de outros elementos em propor√ß√µes de n√∫meros inteiros pequenos para formar compostos.

EXPLICA√á√ÉO: 

GABARITO: E

`;

    function parseQuestions(text) {
      const questions = [];
      const questionPattern = /QUEST√ÉO (\d+)/g;
      const matches = [...text.matchAll(questionPattern)];
      const questionBlocks = text.split(/QUEST√ÉO \d+/).filter(block => block.trim());
      
      questionBlocks.forEach((block, index) => {
        const lines = block.trim().split('\n').filter(line => line.trim());
        if (lines.length < 7) return;
        
        let questionText = '';
        let options = [];
        let correctAnswer = '';
        let explanation = '';
        let hasImage = false;
        const questionNumber = matches[index] ? parseInt(matches[index][1]) : index + 1;
        
        let isReadingExplanation = false;
        
        lines.forEach(line => {
          line = line.trim();
          
          if (line.startsWith('http://') || line.startsWith('https://')) {
            hasImage = true;
            return;
          }
          
          if (line.toUpperCase().startsWith('EXPLICA√á√ÉO:')) {
            isReadingExplanation = true;
            explanation = line.substring(line.indexOf(':') + 1).trim();
            return;
          }
          
          if (isReadingExplanation && !line.toUpperCase().startsWith('GABARITO:')) {
            explanation += (explanation ? ' ' : '') + line;
            return;
          }
          
          if (line.startsWith('A)')) options[0] = line.substring(2).trim();
          else if (line.startsWith('B)')) options[1] = line.substring(2).trim();
          else if (line.startsWith('C)')) options[2] = line.substring(2).trim();
          else if (line.startsWith('D)')) options[3] = line.substring(2).trim();
          else if (line.startsWith('E)')) options[4] = line.substring(2).trim();
          else if (line.toUpperCase().startsWith('GABARITO:')) {
            correctAnswer = line.split(':')[1].trim().toUpperCase();
            isReadingExplanation = false;
          }
          else if (!line.startsWith('QUEST√ÉO') && options.length === 0 && !isReadingExplanation) {
            questionText += (questionText ? ' ' : '') + line;
          }
        });
        
        if (hasImage) {
          questionText = `<span class="image-link" onclick="showImagePreviewAuto('questao_imagens/questao_${questionNumber}')" style="color: #ffcc00; text-decoration: underline; cursor: pointer; margin-bottom: 10px; display: inline-block; font-size: 24px;">üñºÔ∏èVER IMAGEM</span><br>` + questionText;
        }
        
        if (questionText && options.length === 5 && correctAnswer) {
          const correctIndex = {'A': 0, 'B': 1, 'C': 2, 'D': 3, 'E': 4}[correctAnswer];
          questions.push({
            text: questionText,
            options: options,
            correctIndex: correctIndex,
            correctAnswer: options[correctIndex],
            explanation: explanation // Adiciona a explica√ß√£o ao objeto da quest√£o
          });
        }
      });
      
      return questions;
    }

    let questionsBank = parseQuestions(rawQuestionsText);
    let usedQuestions = [];
    let currentTrainingQuestion = null;
    let currentBattleQuestion = null;
    let audioMuted = false;

    function showImagePreview(url) {
      const preview = document.getElementById('image-preview');
      const img = document.getElementById('preview-img');
      img.src = url;
      preview.classList.add('active');
    }

    function hideImagePreview() {
      document.getElementById('image-preview').classList.remove('active');
    }

    function showImagePreviewAuto(basePath) {
      const extensions = ['.png', '.jpg', '.jpeg'];
      const img = document.getElementById('preview-img');
      const preview = document.getElementById('image-preview');
      
      function tryExtension(index) {
        if (index >= extensions.length) {
          alert('Imagem n√£o encontrada! Verifique se o arquivo existe na pasta questao_imagens/');
          return;
        }
        
        img.src = basePath + extensions[index];
        img.onerror = function() {
          tryExtension(index + 1);
        };
        img.onload = function() {
          preview.classList.add('active');
        };
      }
      
      tryExtension(0);
    }

    function generateQuestion() {
      if (usedQuestions.length >= questionsBank.length) {
        usedQuestions = [];
        game.questionsAnswered = 0;
      }
      
      let availableIndexes = [];
      for (let i = 0; i < questionsBank.length; i++) {
        if (!usedQuestions.includes(i)) availableIndexes.push(i);
      }
      
      const randomIndex = availableIndexes[Math.floor(Math.random() * availableIndexes.length)];
      const selectedQuestion = questionsBank[randomIndex];
      const shuffledOptions = [...selectedQuestion.options];
      const correctAnswer = selectedQuestion.correctAnswer;
      
      for (let i = shuffledOptions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
      }
      
      return {
        question: selectedQuestion.text,
        answer: correctAnswer,
        allAnswers: shuffledOptions,
        index: randomIndex,
        explanation: selectedQuestion.explanation
      };
    }

    function markQuestionAsAnswered(questionIndex) {
      if (!usedQuestions.includes(questionIndex)) {
        usedQuestions.push(questionIndex);
        game.questionsAnswered++;
        saveUsedQuestions();
      }
    }

    function updateQuestionCounter() {
      const currentQuestionNumber = (currentTrainingQuestion || currentBattleQuestion) ? game.questionsAnswered + 1 : game.questionsAnswered;
      const counterText = `Quest√µes: ${currentQuestionNumber}/${questionsBank.length}`;
      const trainingCounter = document.getElementById('training-counter');
      const battleCounter = document.getElementById('battle-counter' + currentBattleSuffix);
      if (trainingCounter) trainingCounter.textContent = counterText;
      if (battleCounter) battleCounter.textContent = counterText;
    }

    function saveGame() {
      const saveData = {
        pokemon: game.player.pokemon,
        level: game.player.level,
        exp: game.player.exp,
        expToNext: game.player.expToNext,
        maxHp: game.player.maxHp,
        hp: game.player.hp,
        potions: game.player.potions,
        badges: game.player.badges,
        eliteDefeated: game.player.eliteDefeated,
        questionsAnswered: game.questionsAnswered,
        pendingEvolution: game.pendingEvolution,
        currentBattle: {
          inBattle: game.inBattle,
          battleType: game.battleType,
          currentGym: game.currentGym,
          currentElite: game.currentElite,
          currentOpponent: game.currentOpponent,
          trainingOpponent: game.trainingOpponent,
          currentQuestion: game.battleType === 'gym' || game.battleType === 'elite' ? currentBattleQuestion : currentTrainingQuestion
        }
      };
      localStorage.setItem('pokemonYellowSave', JSON.stringify(saveData));
    }

    function loadGame() {
      const saveData = localStorage.getItem('pokemonYellowSave');
      if (saveData) {
        const data = JSON.parse(saveData);
        game.player.pokemon = data.pokemon;
        game.player.level = data.level;
        game.player.exp = data.exp;
        game.player.expToNext = data.expToNext;
        game.player.potions = data.potions || 0;
        game.player.maxHp = data.maxHp;
        game.player.hp = data.hp;
        game.player.badges = data.badges || [];
        game.player.eliteDefeated = data.eliteDefeated || [];
        game.questionsAnswered = data.questionsAnswered || 0;
        game.pendingEvolution = data.pendingEvolution || null;
        
        if (data.currentBattle && data.currentBattle.inBattle) {
          game.inBattle = data.currentBattle.inBattle;
          game.battleType = data.currentBattle.battleType;
          game.currentGym = data.currentBattle.currentGym;
          game.currentElite = data.currentBattle.currentElite;
          game.currentOpponent = data.currentBattle.currentOpponent;
          game.trainingOpponent = data.currentBattle.trainingOpponent;
          
          if (data.currentBattle.currentQuestion) {
            if (game.battleType === 'training') {
              currentTrainingQuestion = data.currentBattle.currentQuestion;
            } else {
              currentBattleQuestion = data.currentBattle.currentQuestion;
            }
          }
        }
        
        return true;
      }
      return false;
    }

    function saveUsedQuestions() {
      localStorage.setItem('pokemonYellowUsedQuestions', JSON.stringify({
        used: usedQuestions,
        answered: game.questionsAnswered
      }));
    }

    function loadUsedQuestions() {
      const savedQuestions = localStorage.getItem('pokemonYellowUsedQuestions');
      if (savedQuestions) {
        const data = JSON.parse(savedQuestions);
        usedQuestions = data.used || [];
        game.questionsAnswered = data.answered || 0;
      }
    }

    function saveTrophies() {
      localStorage.setItem('pokemonTrophies', JSON.stringify({ trophies: game.player.trophies }));
    }

    function loadTrophies() {
      const trophyData = localStorage.getItem('pokemonTrophies');
      if (trophyData) {
        const data = JSON.parse(trophyData);
        game.player.trophies = data.trophies || 0;
      }
    }

    function resetGame() {
      if (confirm('Tem certeza que deseja resetar todo o progresso?')) {
        localStorage.removeItem('pokemonYellowSave');
        localStorage.removeItem('pokemonYellowUsedQuestions');
        location.reload();
      }
    }

    function resetGameAndTrophies() {
      if (confirm('Tem certeza que deseja resetar todo o progresso E os trof√©us?')) {
        localStorage.removeItem('pokemonYellowSave');
        localStorage.removeItem('pokemonYellowUsedQuestions');
        localStorage.removeItem('pokemonTrophies');
        location.reload();
      }
    }

    function toggleAudio() {
      audioMuted = !audioMuted;
      const allAudios = document.querySelectorAll('audio');
      allAudios.forEach(audio => {
        audio.muted = audioMuted;
      });
      const btn = document.getElementById('audio-toggle-btn');
      btn.textContent = audioMuted ? 'üîá' : 'üîä';
      
      // Salva a prefer√™ncia
      localStorage.setItem('audioMuted', audioMuted);
    }

    function checkEvolution() {
      const currentPokemon = game.player.pokemon;
      const evolution = evolutionData[currentPokemon];
      
      if (evolution && game.player.level >= evolution.level) {
        game.pendingEvolution = evolution.evolvesTo;
        saveGame();
        return true;
      }
      return false;
    }

    function startEvolution() {
      if (!game.pendingEvolution) return;
      
      const fromPokemon = game.player.pokemon;
      const toPokemon = game.pendingEvolution;
      
      const overlay = document.getElementById('evolution-overlay');
      const title = document.getElementById('evolution-title');
      const message = document.getElementById('evolution-message');
      const choiceButtons = document.getElementById('evolution-choice');
      
      const fromSprite = document.getElementById('evolution-from-sprite');
      const toSprite = document.getElementById('evolution-to-sprite');
      const fromName = document.getElementById('evolution-from-name');
      const toName = document.getElementById('evolution-to-name');
      
      fromSprite.src = pokemonData[fromPokemon].frontSprite;
      toSprite.src = pokemonData[toPokemon].frontSprite;
      fromName.textContent = pokemonData[fromPokemon].name;
      toName.textContent = pokemonData[toPokemon].name;
      
      toSprite.style.opacity = '0';
      toName.style.opacity = '0';
      
      overlay.classList.add('active');
      title.textContent = 'O QU√ä?';
      message.textContent = `${pokemonData[fromPokemon].name} est√° evoluindo!`;
      choiceButtons.style.display = 'none';
      
      setTimeout(() => {
        fromSprite.classList.add('evolution-flash');
        
        setTimeout(() => {
          fromSprite.classList.remove('evolution-flash');
          
          setTimeout(() => {
            fromSprite.classList.add('evolution-flash');
            
            setTimeout(() => {
              fromSprite.classList.remove('evolution-flash');
              
              setTimeout(() => {
                fromSprite.classList.add('evolution-flash');
                
                setTimeout(() => {
                  fromSprite.style.opacity = '0';
                  fromName.style.opacity = '0';
                  toSprite.style.opacity = '1';
                  toName.style.opacity = '1';
                  
                  title.textContent = 'PARAB√âNS!';
                  message.textContent = `${pokemonData[fromPokemon].name} evoluiu para ${pokemonData[toPokemon].name}!`;
                  
                  fromSprite.classList.remove('evolution-flash');
                  
                  setTimeout(() => {
                    message.textContent = `Deseja evoluir ${pokemonData[fromPokemon].name} para ${pokemonData[toPokemon].name}?`;
                    choiceButtons.style.display = 'flex';
                  }, 2000);
                }, 300);
              }, 500);
            }, 300);
          }, 500);
        }, 300);
      }, 1000);
    }

    function confirmEvolution() {
      const fromPokemon = game.player.pokemon;
      const toPokemon = game.pendingEvolution;
      
      game.player.pokemon = toPokemon;
      game.pendingEvolution = null;
      
      const overlay = document.getElementById('evolution-overlay');
      const message = document.getElementById('evolution-message');
      const choiceButtons = document.getElementById('evolution-choice');
      
      message.textContent = `${pokemonData[fromPokemon].name} evoluiu para ${pokemonData[toPokemon].name}!`;
      choiceButtons.style.display = 'none';
      
      saveGame();
      setTimeout(() => {
        location.reload();
      }, 2000);
    }

    function cancelEvolution() {
      game.pendingEvolution = null;
      
      const overlay = document.getElementById('evolution-overlay');
      const message = document.getElementById('evolution-message');
      const choiceButtons = document.getElementById('evolution-choice');
      
      message.textContent = 'Evolu√ß√£o cancelada!';
      choiceButtons.style.display = 'none';
      
      saveGame();
      updateGymAvailability();
      
      setTimeout(() => {
        overlay.classList.remove('active');
        document.getElementById('evolution-from-sprite').style.opacity = '1';
        document.getElementById('evolution-from-name').style.opacity = '1';
      }, 1500);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedMuted = localStorage.getItem('audioMuted');
      if (savedMuted === 'true') {
        audioMuted = true;
        document.querySelectorAll('audio').forEach(a => a.muted = true);
        const btn = document.getElementById('audio-toggle-btn');
        if (btn) btn.textContent = 'üîá';
      }
      loadUsedQuestions();
      loadTrophies();
      if (loadGame()) {
        if (game.inBattle) {
          if (game.battleType === 'training' && game.trainingOpponent) {
            showScreen('training-screen');
            audioSystem.play('training-music');
            
            const playerData = pokemonData[game.player.pokemon];
            document.getElementById('training-player-sprite').src = playerData.sprite;
            applyPokemonScaleInBattle(document.getElementById('training-player-sprite'), game.player.pokemon, true);
            document.getElementById('training-pokemon-name').textContent = playerData.name;
            document.getElementById('training-level').textContent = game.player.level;
            
            const opponentData = pokemonData[game.trainingOpponent.name];
            document.getElementById('training-opponent-name').textContent = 'Pokemon Selvagem';
            document.getElementById('training-opponent-pokemon-name').textContent = opponentData.name;
            document.getElementById('training-opponent-level').textContent = game.trainingOpponent.level;
            document.getElementById('training-opponent-sprite').src = opponentData.sprite;
            applyPokemonScaleInBattle(document.getElementById('training-opponent-sprite'), game.trainingOpponent.name, false);
            
            updateTrainingDisplay();
            document.getElementById('training-potion-count').textContent = game.player.potions;
            nextTrainingQuestion();
          } else if (game.battleType === 'gym' && game.currentGym !== null) {
            const gym = gyms[game.currentGym];
            currentBattleSuffix = '-gym-' + game.currentGym;
            showScreen('battle-screen-gym-' + game.currentGym);
            audioSystem.play('gym-music');
            
            const suffix = currentBattleSuffix;
            
            const playerData = pokemonData[game.player.pokemon];
            document.getElementById('battle-player-sprite' + suffix).src = playerData.sprite;
            applyPokemonScaleInBattle(document.getElementById('battle-player-sprite' + suffix), game.player.pokemon, true);
            document.getElementById('battle-player-name' + suffix).textContent = playerData.name;
            document.getElementById('battle-player-level' + suffix).textContent = game.player.level;
            document.getElementById('battle-hp-display' + suffix).textContent = `${game.player.hp}/${game.player.maxHp}`;
            
            const hpPercent = (game.player.hp / game.player.maxHp) * 100;
            const hpBar = document.getElementById('battle-hp-bar' + suffix);

            if (hpPercent > 50) {
              hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
            } else if (hpPercent > 20) {
              hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
            } else {
              hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
            }
            
            const opponentPokemon = pokemonData[game.currentOpponent.name];
            document.getElementById('opponent-name' + suffix).textContent = `L√≠der ${gym.name}`;
            document.getElementById('opponent-pokemon-name' + suffix).textContent = opponentPokemon.name;
            document.getElementById('opponent-level' + suffix).textContent = game.currentOpponent.level;
            document.getElementById('opponent-hp-display' + suffix).textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
            document.getElementById('battle-opponent-sprite' + suffix).src = opponentPokemon.sprite;
            applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite' + suffix), game.currentOpponent.name, false);
            
            const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
            const oppHpBar = document.getElementById('opponent-hp-bar' + suffix);

            if (oppHpPercent > 50) {
              oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
            } else if (oppHpPercent > 20) {
              oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
            } else {
              oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
            }
            
            document.getElementById('battle-message' + suffix).innerHTML = `${gym.name} desafia voc√™ para uma batalha!`;
            document.getElementById('battle-message' + suffix).style.background = 'rgba(0, 0, 0, 0.9)';

            updateBattleDisplay();
            document.getElementById('battle-potion-count' + currentBattleSuffix).textContent = game.player.potions;
            nextBattleQuestion();
          } else if (game.battleType === 'elite' && game.currentElite !== null) {
            const elite = eliteFour[game.currentElite];
            currentBattleSuffix = '-elite-' + game.currentElite;
            showScreen('battle-screen-elite-' + game.currentElite);
            audioSystem.play('elite-music');
            
            const suffix = currentBattleSuffix;
            
            const playerData = pokemonData[game.player.pokemon];
            document.getElementById('battle-player-sprite' + suffix).src = playerData.sprite;
            applyPokemonScaleInBattle(document.getElementById('battle-player-sprite' + suffix), game.player.pokemon, true);
            document.getElementById('battle-player-name' + suffix).textContent = playerData.name;
            document.getElementById('battle-player-level' + suffix).textContent = game.player.level;
            document.getElementById('battle-hp-display' + suffix).textContent = `${game.player.hp}/${game.player.maxHp}`;
            
            const hpPercent = (game.player.hp / game.player.maxHp) * 100;
            const hpBar = document.getElementById('battle-hp-bar' + suffix);

            if (hpPercent > 50) {
              hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
            } else if (hpPercent > 20) {
              hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
            } else {
              hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
            }
            
            const opponentPokemon = pokemonData[game.currentOpponent.name];
            document.getElementById('opponent-name' + suffix).textContent = `${elite.name} - ${elite.title}`;
            document.getElementById('opponent-pokemon-name' + suffix).textContent = opponentPokemon.name;
            document.getElementById('opponent-level' + suffix).textContent = game.currentOpponent.level;
            document.getElementById('opponent-hp-display' + suffix).textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
            document.getElementById('battle-opponent-sprite' + suffix).src = opponentPokemon.sprite;
            applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite' + suffix), game.currentOpponent.name, false);
            
            const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
            const oppHpBar = document.getElementById('opponent-hp-bar' + suffix);

            if (oppHpPercent > 50) {
              oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
            } else if (oppHpPercent > 20) {
              oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
            } else {
              oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
            }
            
            document.getElementById('battle-message' + suffix).innerHTML = `${elite.name} desafia voc√™!`;
            document.getElementById('battle-message' + suffix).style.background = 'rgba(0, 0, 0, 0.9)';

            updateBattleDisplay();
            document.getElementById('battle-potion-count' + currentBattleSuffix).textContent = game.player.potions;
            nextBattleQuestion();
          }
        } else {
          showScreen('map-screen');
          audioSystem.play('map-music');
          updatePlayerDisplay();
          updateGymAvailability();
          
          if (game.pendingEvolution) {
            setTimeout(() => startEvolution(), 500);
          }
        }
      } else {
        showScreen('starter-screen');
      }
    });

    const evolutionData = {
      bulbasaur: { evolvesTo: 'ivysaur', level: 16 },
      ivysaur: { evolvesTo: 'venusaur', level: 32 },
      charmander: { evolvesTo: 'charmeleon', level: 16 },
      charmeleon: { evolvesTo: 'charizard', level: 36 },
      squirtle: { evolvesTo: 'wartortle', level: 16 },
      wartortle: { evolvesTo: 'blastoise', level: 36 }
    };

    const pokemonData = {
      bulbasaur: { name: 'Bulbasaur', sprite: 'pokemon_assets/sprites_back/bulbasaur.gif', frontSprite: 'pokemon_assets/sprites_front/bulbasaur.gif', scale: 1.0, offsetY: -100 },
      ivysaur: { name: 'Ivysaur', sprite: 'pokemon_assets/sprites_back/ivysaur.gif', frontSprite: 'pokemon_assets/sprites_front/ivysaur.gif', scale: 1.4, offsetY: -80 },
      venusaur: { name: 'Venusaur', sprite: 'pokemon_assets/sprites_back/venusaur.gif', frontSprite: 'pokemon_assets/sprites_front/venusaur.gif', scale: 1.7, offsetY: -50 },
      charmander: { name: 'Charmander', sprite: 'pokemon_assets/sprites_back/charmander.gif', frontSprite: 'pokemon_assets/sprites_front/charmander.gif', scale: 1.0, offsetY: -100 },
      charmeleon: { name: 'Charmeleon', sprite: 'pokemon_assets/sprites_back/charmeleon.gif', frontSprite: 'pokemon_assets/sprites_front/charmeleon.gif', scale: 1.5, offsetY: -80 },
      charizard: { name: 'Charizard', sprite: 'pokemon_assets/sprites_back/charizard.gif', frontSprite: 'pokemon_assets/sprites_front/charizard.gif', scale: 2.9 },
      squirtle: { name: 'Squirtle', sprite: 'pokemon_assets/sprites_back/squirtle.gif', frontSprite: 'pokemon_assets/sprites_front/squirtle.gif', scale: 1.0, offsetY: -100 },
      wartortle: { name: 'Wartortle', sprite: 'pokemon_assets/sprites_back/wartortle.gif', frontSprite: 'pokemon_assets/sprites_front/wartortle.gif', scale: 1.3, offsetY: -80 },
      blastoise: { name: 'Blastoise', sprite: 'pokemon_assets/sprites_back/blastoise.gif', frontSprite: 'pokemon_assets/sprites_front/blastoise.gif', scale: 1.9, offsetY: -50 },
      geodude: { name: 'Geodude', sprite: 'pokemon_assets/sprites_front/geodude.gif', scale: 1.3, offsetY: 50 },
      onix: { name: 'Onix', sprite: 'pokemon_assets/sprites_front/onix.gif', scale: 1.9, offsetY: -15 },
      staryu: { name: 'Staryu', sprite: 'pokemon_assets/sprites_front/staryu.gif', scale: 1.0, offsetY: 0 },
      starmie: { name: 'Starmie', sprite: 'pokemon_assets/sprites_front/starmie.gif', scale: 1.1, offsetY: 0 },
      voltorb: { name: 'Voltorb', sprite: 'pokemon_assets/sprites_front/voltorb.gif', scale: 0.7, offsetY: 30 },
      pikachu: { name: 'Pikachu', sprite: 'pokemon_assets/sprites_front/pikachu.gif', scale: 1.0, offsetY: 50 },
      raichu: { name: 'Raichu', sprite: 'pokemon_assets/sprites_front/raichu.gif', scale: 1.2, offsetY: -40 },
      victreebel: { name: 'Victreebel', sprite: 'pokemon_assets/sprites_front/victreebel.gif', scale: 1.5, offsetY: 40 },
      tangela: { name: 'Tangela', sprite: 'pokemon_assets/sprites_front/tangela.gif', scale: 1.0, offsetY: 40 },
      vileplume: { name: 'Vileplume', sprite: 'pokemon_assets/sprites_front/vileplume.gif', scale: 1.0, offsetY: 80 },
      koffing: { name: 'Koffing', sprite: 'pokemon_assets/sprites_front/koffing.gif', scale: 1.5, offsetY: 40 },
      muk: { name: 'Muk', sprite: 'pokemon_assets/sprites_front/muk.gif', scale: 1.4, offsetY: 80 },
      weezing: { name: 'Weezing', sprite: 'pokemon_assets/sprites_front/weezing.gif', scale: 1.6, offsetY: 40 },
      abra: { name: 'Abra', sprite: 'pokemon_assets/sprites_front/abra.gif', scale: 1.0, offsetY: 40 },
      kadabra: { name: 'Kadabra', sprite: 'pokemon_assets/sprites_front/kadabra.gif', scale: 1.2, offsetY: 40 },
      mrmime: { name: 'Mr. Mime', sprite: 'pokemon_assets/sprites_front/mrmime.gif', scale: 1.2, offsetY: 40 },
      venomoth: { name: 'Venomoth', sprite: 'pokemon_assets/sprites_front/venomoth.gif', scale: 1.3, offsetY: 40 },
      alakazam: { name: 'Alakazam', sprite: 'pokemon_assets/sprites_front/alakazam.gif', scale: 1.3, offsetY: 40 },
      growlithe: { name: 'Growlithe', sprite: 'pokemon_assets/sprites_front/growlithe.gif', scale: 0.9, offsetY: 0 },
      ponyta: { name: 'Ponyta', sprite: 'pokemon_assets/sprites_front/ponyta.gif', scale: 1.1, offsetY: 0 },
      rapidash: { name: 'Rapidash', sprite: 'pokemon_assets/sprites_front/rapidash.gif', scale: 1.6, offsetY: 40 },
      arcanine: { name: 'Arcanine', sprite: 'pokemon_assets/sprites_front/arcanine.gif', scale: 1.2, offsetY: 0 },
      rhyhorn: { name: 'Rhyhorn', sprite: 'pokemon_assets/sprites_front/rhyhorn.gif', scale: 1.3, offsetY: 40 },
      dugtrio: { name: 'Dugtrio', sprite: 'pokemon_assets/sprites_front/dugtrio.gif', scale: 1.2, offsetY: 40 },
      nidoqueen: { name: 'Nidoqueen', sprite: 'pokemon_assets/sprites_front/nidoqueen.gif', scale: 1.3, offsetY: 0 },
      nidoking: { name: 'Nidoking', sprite: 'pokemon_assets/sprites_front/nidoking.gif', scale: 2.0, offsetY: 60 },
      rhydon: { name: 'Rhydon', sprite: 'pokemon_assets/sprites_front/rhydon.gif', scale: 1.8, offsetY: 40 },
      dewgong: { name: 'Dewgong', sprite: 'pokemon_assets/sprites_front/dewgong.gif', scale: 1.8, offsetY: 60 },
      cloyster: { name: 'Cloyster', sprite: 'pokemon_assets/sprites_front/cloyster.gif', scale: 1.4, offsetY: 30 },
      slowbro: { name: 'Slowbro', sprite: 'pokemon_assets/sprites_front/slowbro.gif', scale: 1.5, offsetY: 60 },
      jynx: { name: 'Jynx', sprite: 'pokemon_assets/sprites_front/jynx.gif', scale: 1.4, offsetY: 40 },
      lapras: { name: 'Lapras', sprite: 'pokemon_assets/sprites_front/lapras.gif', scale: 1.6, offsetY: 40 },
      hitmonchan: { name: 'Hitmonchan', sprite: 'pokemon_assets/sprites_front/hitmonchan.gif', scale: 1.0, offsetY: 0 },
      hitmonlee: { name: 'Hitmonlee', sprite: 'pokemon_assets/sprites_front/hitmonlee.gif', scale: 1.0, offsetY: 0 },
      machamp: { name: 'Machamp', sprite: 'pokemon_assets/sprites_front/machamp.gif', scale: 1.6, offsetY: 20 },
      gengar: { name: 'Gengar', sprite: 'pokemon_assets/sprites_front/gengar.gif', scale: 1.4, offsetY: 40 },
      golbat: { name: 'Golbat', sprite: 'pokemon_assets/sprites_front/golbat.gif', scale: 2.5, offsetY: 50 },
      haunter: { name: 'Haunter', sprite: 'pokemon_assets/sprites_front/haunter.gif', scale: 1.4, offsetY: 50 },
      arbok: { name: 'Arbok', sprite: 'pokemon_assets/sprites_front/arbok.gif', scale: 1.8, offsetY: 40 },
      gyarados: { name: 'Gyarados', sprite: 'pokemon_assets/sprites_front/gyarados.gif', scale: 2.1, offsetY: 50 },
      dragonair: { name: 'Dragonair', sprite: 'pokemon_assets/sprites_front/dragonair.gif', scale: 1.2, offsetY: 0 },
      aerodactyl: { name: 'Aerodactyl', sprite: 'pokemon_assets/sprites_front/aerodactyl.gif', scale: 2.6, offsetY: 60 },
      dragonite: { name: 'Dragonite', sprite: 'pokemon_assets/sprites_front/dragonite.gif', scale: 1.8, offsetY: 20 },
      pidgeot: { name: 'Pidgeot', sprite: 'pokemon_assets/sprites_front/pidgeot.gif', scale: 1.8, offsetY: 20 },
      exeggutor: { name: 'Exeggutor', sprite: 'pokemon_assets/sprites_front/exeggutor.gif', scale: 2.7, offsetY: 60 },
      rattata: { name: 'Rattata', sprite: 'pokemon_assets/sprites_front/rattata.gif', scale: 0.75, offsetY: 0 },
      raticate: { name: 'Raticate', sprite: 'pokemon_assets/sprites_front/raticate.gif', scale: 1.35, offsetY: 40 },
      spearow: { name: 'Spearow', sprite: 'pokemon_assets/sprites_front/spearow.gif', scale: 0.55, offsetY: -20 },
      fearow: { name: 'Fearow', sprite: 'pokemon_assets/sprites_front/fearow.gif', scale: 2.2, offsetY: 60 },
      ekans: { name: 'Ekans', sprite: 'pokemon_assets/sprites_front/ekans.gif', scale: 1.0, offsetY: 40 },
      sandshrew: { name: 'Sandshrew', sprite: 'pokemon_assets/sprites_front/sandshrew.gif', scale: 0.8, offsetY: 40 },
      sandslash: { name: 'Sandslash', sprite: 'pokemon_assets/sprites_front/sandslash.gif', scale: 1.2, offsetY: 40 },
      nidorina: { name: 'Nidorina', sprite: 'pokemon_assets/sprites_front/nidorina.gif', scale: 0.9, offsetY: 0 },
      nidorino: { name: 'Nidorino', sprite: 'pokemon_assets/sprites_front/nidorino.gif', scale: 0.9, offsetY: 50 },
      clefairy: { name: 'Clefairy', sprite: 'pokemon_assets/sprites_front/clefairy.gif', scale: 1.1, offsetY: 40 },
      vulpix: { name: 'Vulpix', sprite: 'pokemon_assets/sprites_front/vulpix.gif', scale: 0.9, offsetY: 40 },
      ninetales: { name: 'Ninetales', sprite: 'pokemon_assets/sprites_front/ninetales.gif', scale: 1.4, offsetY: 40 },
      jigglypuff: { name: 'Jigglypuff', sprite: 'pokemon_assets/sprites_front/jigglypuff.gif', scale: 0.8, offsetY: 40 },
      zubat: { name: 'Zubat', sprite: 'pokemon_assets/sprites_front/zubat.gif', scale: 1.6, offsetY: 40 },
      oddish: { name: 'Oddish', sprite: 'pokemon_assets/sprites_front/oddish.gif', scale: 0.9, offsetY: 40 },
      gloom: { name: 'Gloom', sprite: 'pokemon_assets/sprites_front/gloom.gif', scale: 1.0, offsetY: 40 },
      paras: { name: 'Paras', sprite: 'pokemon_assets/sprites_front/paras.gif', scale: 0.9, offsetY: 60 },
      parasect: { name: 'Parasect', sprite: 'pokemon_assets/sprites_front/parasect.gif', scale: 1.2, offsetY: 60 },
      venonat: { name: 'Venonat', sprite: 'pokemon_assets/sprites_front/venonat.gif', scale: 1.1, offsetY: 30 },
      diglett: { name: 'Diglett', sprite: 'pokemon_assets/sprites_front/diglett.gif', scale: 1.0, offsetY: 60 },
      meowth: { name: 'Meowth', sprite: 'pokemon_assets/sprites_front/meowth.gif', scale: 0.85, offsetY: 20 },
      persian: { name: 'Persian', sprite: 'pokemon_assets/sprites_front/persian.gif', scale: 1.1, offsetY: 30 },
      psyduck: { name: 'Psyduck', sprite: 'pokemon_assets/sprites_front/psyduck.gif', scale: 0.8, offsetY: 30 },
      golduck: { name: 'Golduck', sprite: 'pokemon_assets/sprites_front/golduck.gif', scale: 1.3, offsetY: 30 },
      mankey: { name: 'Mankey', sprite: 'pokemon_assets/sprites_front/mankey.gif', scale: 1.0, offsetY: 30 },
      primeape: { name: 'Primeape', sprite: 'pokemon_assets/sprites_front/primeape.gif', scale: 1.2, offsetY: 40 },
      poliwag: { name: 'Poliwag', sprite: 'pokemon_assets/sprites_front/poliwag.gif', scale: 1.0, offsetY: 60 },
      poliwhirl: { name: 'Poliwhirl', sprite: 'pokemon_assets/sprites_front/poliwhirl.gif', scale: 1.5, offsetY: 80 },
      bellsprout: { name: 'Bellsprout', sprite: 'pokemon_assets/sprites_front/bellsprout.gif', scale: 1.2, offsetY: 40 },
      weepinbell: { name: 'Weepinbell', sprite: 'pokemon_assets/sprites_front/weepinbell.gif', scale: 1.2, offsetY: 60 },
      zapdos: { name: 'Zapdos', sprite: 'pokemon_assets/sprites_front/zapdos.gif', scale: 2.0, offsetY: 60 },
      moltres: { name: 'Moltres', sprite: 'pokemon_assets/sprites_front/moltres.gif', scale: 2.4, offsetY: 80 },
      articuno: { name: 'Articuno', sprite: 'pokemon_assets/sprites_front/articuno.gif', scale: 2.4, offsetY: 60 },
      mewtwo: { name: 'Mewtwo', sprite: 'pokemon_assets/sprites_front/mewtwo.gif', scale: 2.2, offsetY: 80 },
      mew: { name: 'Mew', sprite: 'pokemon_assets/sprites_front/mew.gif', scale: 0.9, offsetY: 0 }
    };

    // ZZZZ  
    const trainingPokemon = ['rattata', 'raticate', 'spearow', 'fearow', 'ekans', 'sandshrew', 'sandslash', 'nidorina', 'nidorino', 'clefairy', 'vulpix', 'jigglypuff', 'zubat', 'oddish', 'gloom', 'paras', 'parasect', 'venonat', 'diglett', 'meowth', 'persian', 'psyduck', 'golduck', 'mankey', 'primeape', 'poliwag', 'poliwhirl', 'bellsprout', 'weepinbell'];

    const gyms = [
      { name: 'Brock', city: 'Pewter City', badge: 'Boulder Badge', requiredLevel: 10, pokemon: [{ name: 'geodude', level: 10 }, { name: 'onix', level: 14 }] },
      { name: 'Misty', city: 'Cerulean City', badge: 'Cascade Badge', requiredLevel: 18, pokemon: [{ name: 'staryu', level: 23 }, { name: 'starmie', level: 25 }] },
      { name: 'Lt. Surge', city: 'Vermilion City', badge: 'Thunder Badge', requiredLevel: 25, pokemon: [{ name: 'voltorb', level: 27 }, { name: 'pikachu', level: 30 }, { name: 'raichu', level: 33 }] },
      { name: 'Erika', city: 'Celadon City', badge: 'Rainbow Badge', requiredLevel: 30, pokemon: [{ name: 'victreebel', level: 33 }, { name: 'tangela', level: 35 }, { name: 'vileplume', level: 39 }] },
      { name: 'Koga', city: 'Fuchsia City', badge: 'Soul Badge', requiredLevel: 35, pokemon: [{ name: 'muk', level: 37 }, { name: 'koffing', level: 37 }, { name: 'weezing', level: 39 }, { name: 'venomoth', level: 43 }] },
      { name: 'Sabrina', city: 'Saffron City', badge: 'Marsh Badge', requiredLevel: 38, pokemon: [{ name: 'abra', level: 40 }, { name: 'kadabra', level: 42 }, { name: 'alakazam', level: 43 }] },
      { name: 'Blaine', city: 'Cinnabar Island', badge: 'Volcano Badge', requiredLevel: 42, pokemon: [{ name: 'growlithe', level: 42 }, { name: 'ponyta', level: 43 }, { name: 'rapidash', level: 45 }, { name: 'arcanine', level: 47 }, { name: 'ninetales', level: 50 }] },
      { name: 'Giovanni', city: 'Viridian City', badge: 'Earth Badge', requiredLevel: 45, pokemon: [{ name: 'dugtrio', level: 50 }, { name: 'persian', level: 53 }, { name: 'nidoqueen', level: 53 }, { name: 'nidoking', level: 55 }, { name: 'rhydon', level: 55 }] }
    ];

    const eliteFour = [
      { name: 'Lorelei', title: 'Mestre de Gelo', requiredLevel: 50, pokemon: [{ name: 'dewgong', level: 53 }, { name: 'cloyster', level: 55 }, { name: 'slowbro', level: 56 }, { name: 'jynx', level: 57 }, { name: 'lapras', level: 60 }] },
      { name: 'Bruno', title: 'Mestre de Luta', requiredLevel: 55, pokemon: [{ name: 'onix', level: 58 }, { name: 'hitmonchan', level: 61 }, { name: 'hitmonlee', level: 63 }, { name: 'onix', level: 66 }, { name: 'machamp', level: 68 }] },
      { name: 'Agatha', title: 'Mestre Fantasma', requiredLevel: 60, pokemon: [{ name: 'gengar', level: 66 }, { name: 'golbat', level: 67 }, { name: 'haunter', level: 67 }, { name: 'arbok', level: 68 }, { name: 'gengar', level: 70 }] },
      { name: 'Lance', title: 'Mestre de Drag√µes', requiredLevel: 75, pokemon: [{ name: 'gyarados', level: 77 }, { name: 'dragonair', level: 78 }, { name: 'dragonair', level: 80 }, { name: 'aerodactyl', level: 81 }, { name: 'dragonite', level: 85 }] },
      { name: 'Ash', title: 'Campe√£o Pokemon', requiredLevel: 100, pokemon: [{ name: 'pidgeot', level: 100 }, { name: 'zapdos', level: 100 }, { name: 'moltres', level: 100 }, { name: 'articuno', level: 100 }, { name: 'mewtwo', level: 100 }, { name: 'mew', level: 100 }] }
    ];

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      if (screenId === 'map-screen') audioSystem.play('map-music');
    }

    function selectStarter(pokemon) {
      game.player.pokemon = pokemon;
      saveGame();
      updatePlayerDisplay();
      showScreen('map-screen');
      audioSystem.play('map-music');
      updateGymAvailability();
    }

    // Abre o menu do Pokemon Center
    function openPokemonCenterMenu() {
      const menu = document.getElementById('pokemon-center-menu');
      menu.classList.add('active');
      
      // Atualiza o estado do bot√£o de po√ß√µes
      updatePotionButtonState();
    }

    // Fecha o menu do Pokemon Center
    function closePokemonCenterMenu() {
      const menu = document.getElementById('pokemon-center-menu');
      menu.classList.remove('active');
    }

    // Atualiza o estado do bot√£o de po√ß√µes baseado na quantidade
    function updatePotionButtonState() {
      const potionBtn = document.getElementById('potion-minigame-btn');
      
      if (game.player.potions > 0) {
        potionBtn.disabled = true;
        potionBtn.style.opacity = '0.5';
        potionBtn.querySelector('small').textContent = `Voc√™ tem ${game.player.potions} po√ß√£o(√µes). Use-as primeiro!`;
      } else {
        potionBtn.disabled = false;
        potionBtn.style.opacity = '1';
        potionBtn.querySelector('small').textContent = 'Jogue o minigame (apenas com 0 po√ß√µes)';
      }
    }

    // Cura o Pokemon diretamente do menu
    function healPokemonFromMenu() {
      if (game.player.hp === game.player.maxHp) {
        alert('‚ù§Ô∏è Seu Pok√©mon j√° est√° com HP cheio!');
        return;
      }
      
      // Cura o Pokemon
      game.player.hp = game.player.maxHp;
      saveGame();
      updatePlayerDisplay();
      
      // Mensagem de sucesso
      alert('‚ú® Seu Pok√©mon foi curado completamente!\n\n‚ù§Ô∏è HP restaurado: ' + game.player.maxHp + '/' + game.player.maxHp);
      
      // Fecha o menu
      closePokemonCenterMenu();
    }

    // Inicia o minigame de po√ß√µes do menu
    function startPotionMinigame() {
      // Verifica se o jogador tem alguma po√ß√£o
      if (game.player.potions > 0) {
        alert('‚ùå Voc√™ j√° tem po√ß√µes! (Quantidade atual: ' + game.player.potions + ')\n\nVoc√™ s√≥ pode jogar o minigame quando tiver 0 po√ß√µes.\n\nUse suas po√ß√µes em batalha primeiro!');
        return;
      }
      
      // Fecha o menu do Pokemon Center
      closePokemonCenterMenu();
      
      // Inicia o minigame
      startMinigame();
    }

    function startMinigame() {
      // Reset vari√°veis
      minigameActive = true;
      minigameTimeLeft = 10;
      minigameCaught = 0;
      minigameBasketPosition = 50;
      
      // Mostra o modal
      document.getElementById('minigame-overlay').classList.add('active');
      document.getElementById('minigame-modal').classList.add('active');
      document.getElementById('minigame-result').classList.remove('show');
      document.getElementById('minigame-area').style.display = 'block';
      
      // Atualiza displays
      document.getElementById('minigame-caught').textContent = '0';
      
      // Posiciona a cesta no centro
      const basket = document.getElementById('basket');
      const gameArea = document.getElementById('minigame-area');
      basket.style.left = '50%';
      basket.style.transform = 'translateX(-50%)';
      
      // Adiciona controles
      setupMinigameControls();
      
      // Contagem regressiva de 3 segundos
      let countdown = 3;
      const timerElement = document.querySelector('.minigame-timer');
      timerElement.classList.add('countdown-mode');
      timerElement.innerHTML = '<span id="minigame-time">' + countdown + '</span>';

      const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          document.getElementById('minigame-time').textContent = countdown;
        } else {
          clearInterval(countdownInterval);
          timerElement.classList.remove('countdown-mode');
          timerElement.innerHTML = ''; // LIMPA O CONTE√öDO
          
          // Inicia a cria√ß√£o de itens (6 por segundo = 166ms - mais r√°pido!)
          let ballsCreated = 0;
          minigamePokeballInterval = setInterval(() => {
            if (ballsCreated < minigameTotalBalls && minigameActive) {
              createPokeball();
              ballsCreated++;
            }
            if (ballsCreated >= minigameTotalBalls) {
              clearInterval(minigamePokeballInterval);
              // Aguarda 3 segundos ap√≥s o √∫ltimo item para terminar
              setTimeout(() => {
                if (minigameActive) {
                  endMinigame();
                }
              }, 1500);
            }
          }, 166); // 6 itens por segundo (mais r√°pido)
        }
      }, 1000);
    }

    function setupMinigameControls() {
      const gameArea = document.getElementById('minigame-area');
      const basket = document.getElementById('basket');
      
      // Controle por teclado
      document.addEventListener('keydown', handleKeyPress);
      
      // Controle por mouse
      gameArea.addEventListener('mousemove', handleMouseMove);
      
      // Controle por toque (mobile)
      gameArea.addEventListener('touchmove', handleTouchMove);
      gameArea.addEventListener('touchstart', handleTouchMove);
    }

    function handleKeyPress(e) {
      if (!minigameActive) return;
      
      const basket = document.getElementById('basket');
      const gameArea = document.getElementById('minigame-area');
      const basketWidth = basket.offsetWidth;
      const areaWidth = gameArea.offsetWidth;
      let currentLeft = parseInt(basket.style.left) || (areaWidth / 2);
      
      if (e.key === 'ArrowLeft') {
        currentLeft = Math.max(0, currentLeft - 20);
      } else if (e.key === 'ArrowRight') {
        currentLeft = Math.min(areaWidth - basketWidth, currentLeft + 20);
      }
      
      basket.style.left = currentLeft + 'px';
      basket.style.transform = 'translateX(0)';
    }

    function handleMouseMove(e) {
      if (!minigameActive) return;
      
      const gameArea = document.getElementById('minigame-area');
      const basket = document.getElementById('basket');
      const rect = gameArea.getBoundingClientRect();
      const basketWidth = basket.offsetWidth;
      
      let x = e.clientX - rect.left - (basketWidth / 2);
      x = Math.max(0, Math.min(rect.width - basketWidth, x));
      
      basket.style.left = x + 'px';
      basket.style.transform = 'translateX(0)';
    }

    function handleTouchMove(e) {
      if (!minigameActive) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      const gameArea = document.getElementById('minigame-area');
      const basket = document.getElementById('basket');
      const rect = gameArea.getBoundingClientRect();
      const basketWidth = basket.offsetWidth;
      
      let x = touch.clientX - rect.left - (basketWidth / 2);
      x = Math.max(0, Math.min(rect.width - basketWidth, x));
      
      basket.style.left = x + 'px';
      basket.style.transform = 'translateX(0)';
    }

    function createPokeball() {
      // Definir itens bons e ruins
      const goodItem = 'üß™'; // Comprimido (item bom)
      const badItems = ['üí£', 'üí©', 'üíÄ', '‚ò†Ô∏è']; // Comidas ruins

      // Decidir aleatoriamente se ser√° item bom ou ruim (30% de chance de ruim)
      const badItemChance = 0.2 + (minigameCaught * 0.005);
      const isBadItem = Math.random() < badItemChance;

      // Escolher qual emoji usar
      let itemEmoji;
      if (isBadItem) {
        // Escolhe aleatoriamente um item ruim do array
        const randomIndex = Math.floor(Math.random() * badItems.length);
        itemEmoji = badItems[randomIndex];
      } else {
        itemEmoji = goodItem;
      }
      const gameArea = document.getElementById('minigame-area');
      const pokeball = document.createElement('div');
      pokeball.className = 'pokeball-falling';

      // Adicionar o emoji e identificar se √© ruim
      pokeball.textContent = itemEmoji;
      pokeball.setAttribute('data-is-bad', isBadItem);
      // Estilo para o emoji aparecer
      pokeball.style.fontSize = '30px';
      pokeball.style.display = 'flex';
      pokeball.style.alignItems = 'center';
      pokeball.style.justifyContent = 'center';
      pokeball.style.background = 'transparent';
      pokeball.style.border = 'none';
            
      // Posi√ß√£o aleat√≥ria horizontal
      const areaWidth = gameArea.offsetWidth;
      const randomX = Math.random() * (areaWidth - 40);
      pokeball.style.left = randomX + 'px';
      pokeball.style.top = '0px';
      
      // Velocidade de queda (2 segundos para cair)
      pokeball.style.animationDuration = '1.75s';
      
      gameArea.appendChild(pokeball);
      
      // Verifica colis√£o continuamente
      const checkCollision = setInterval(() => {
        if (!minigameActive) {
          clearInterval(checkCollision);
          return;
        }
        
        const basket = document.getElementById('basket');
        const basketRect = basket.getBoundingClientRect();
        const ballRect = pokeball.getBoundingClientRect();
        
        // Verifica se a pok√©bola est√° na altura da cesta
        if (ballRect.bottom >= basketRect.top && ballRect.top <= basketRect.bottom) {
          // Verifica se est√° dentro da √°rea horizontal da cesta
          if (ballRect.left < basketRect.right && ballRect.right > basketRect.left) {
            const isBad = pokeball.getAttribute('data-is-bad') === 'true';

            if (isBad) {
              // Pegou item RUIM: perde 1 ponto
              minigameCaught = Math.max(0, minigameCaught - 1);
              document.getElementById('minigame-caught').textContent = minigameCaught;
              
              // Efeito visual RUIM (vermelho)
              basket.style.background = '#FF0000';
              setTimeout(() => {
                basket.style.background = '#8B4513';
              }, 100);
            } else {
              // Pegou item BOM: ganha 1 ponto
              minigameCaught++;
              document.getElementById('minigame-caught').textContent = minigameCaught;
              
              // Efeito visual BOM (dourado)
              basket.style.background = '#FFD700';
              setTimeout(() => {
                basket.style.background = '#8B4513';
              }, 100);
            }

            pokeball.remove();
            clearInterval(checkCollision);
          }
        }
        
        // Remove a pok√©bola se saiu da tela
        if (ballRect.top > gameArea.getBoundingClientRect().bottom) {
          pokeball.remove();
          clearInterval(checkCollision);
        }
      }, 50);
    }

    function endMinigame() {
      minigameActive = false;
      
      // Limpa timers
      if (minigameTimer) {
        clearInterval(minigameTimer);
      }
      clearInterval(minigamePokeballInterval);
      
      // Remove controles
      document.removeEventListener('keydown', handleKeyPress);
      
      // Remove pok√©bolas restantes
      const pokeballs = document.querySelectorAll('.pokeball-falling');
      pokeballs.forEach(ball => ball.remove());
      
      // Esconde √°rea do jogo
      document.getElementById('minigame-area').style.display = 'none';
      
      // Mostra resultado
      const resultDiv = document.getElementById('minigame-result');
      const resultTitle = document.getElementById('result-title');
      const resultMessage = document.getElementById('result-message');
      
      resultDiv.classList.add('show');
      
      if (minigameCaught >= 30) {
        // Sucesso! Cura o Pok√©mon
        resultTitle.textContent = 'üéâ SUCESSO! üéâ';
        resultMessage.textContent = `Voc√™ capturou ${minigameCaught} po√ß√µes!\nVoc√™ ganhou 1 Po√ß√£o para usar em batalhas!`;
        resultTitle.style.color = '#00ff00';
        
        // Ganha uma po√ß√£o
        game.player.potions++;
        updatePlayerDisplay();
        saveGame();
        updatePotionButtonState();
      } else {
        // Falhou
        resultTitle.textContent = 'üò¢ FALHOU! üò¢';
        resultMessage.textContent = `Voc√™ capturou apenas ${minigameCaught} po√ß√µes.\nPrecisa capturar pelo menos 30 para ganhar 1 po√ß√£o.\nTente novamente!`;
        resultTitle.style.color = '#ff0000';
      }
    }

    function closeMinigame() {
      document.getElementById('minigame-overlay').classList.remove('active');
      document.getElementById('minigame-modal').classList.remove('active');
      document.getElementById('minigame-result').classList.remove('show');
    }

    function usePotion(battleType, suffix = '') {
      // Corrigir o sufixo: se vier 'gym-0', deve virar '-gym-0'
      const idSuffix = suffix ? `-${suffix}` : '';
      
      if (game.player.potions <= 0) {
        alert('Voc√™ n√£o tem po√ß√µes!');
        return;
      }
      
      if (game.player.hp === game.player.maxHp) {
        alert('Seu HP j√° est√° cheio!');
        return;
      }
      
      game.player.potions--;
      game.player.hp = game.player.maxHp;

      if (game.player.potions === 0) {
        if (battleType === 'training') {
          document.getElementById('training-potion-btn').disabled = true;
        } else {
          document.getElementById(`battle-potion-btn${idSuffix}`).disabled = true;
        }
      }
      
      saveGame();
      
      if (battleType === 'training') {
        updateTrainingDisplay();
        document.getElementById('training-potion-count').textContent = game.player.potions;
      } else {
        updateBattleDisplay();
        // Corrigir: usar idSuffix que j√° inclui o h√≠fen
        const potionCountEl = document.getElementById(`battle-potion-count${idSuffix}`);
        if (potionCountEl) potionCountEl.textContent = game.player.potions;
      }
      
      updatePlayerDisplay();
      
      // Corrigir: buscar o elemento correto com o sufixo
      const messageEl = document.getElementById(
        battleType === 'training' ? 'training-message' : `battle-message${idSuffix}`
      );
      
      if (!messageEl) {
        console.error('Elemento de mensagem n√£o encontrado:', `battle-message${idSuffix}`);
        return;
      }
      
      const originalBg = messageEl.style.background;
      messageEl.innerHTML = 'üß™ Voc√™ usou uma Po√ß√£o! HP restaurado completamente!';
      messageEl.style.background = 'rgba(0, 150, 255, 0.9)';
      
      setTimeout(() => {
        messageEl.style.background = originalBg;
      }, 2000);
    }

    function updatePlayerDisplay() {
      const data = pokemonData[game.player.pokemon];
      const spriteImg = document.getElementById('player-sprite');
      spriteImg.src = data.frontSprite;
      
      // Remove todas as classes de tamanho primeiro
      spriteImg.classList.remove('starter-small', 'mid-small', 'final-small');
      
      // Define os grupos de tamanho
      const starterSmall = ['bulbasaur', 'charmander', 'squirtle'];
      const midSmall = ['ivysaur', 'charmeleon', 'wartortle'];
      const finalSmall = ['venusaur', 'charizard', 'blastoise'];
      
      // Adiciona a classe apropriada
      if (starterSmall.includes(game.player.pokemon)) {
        spriteImg.classList.add('starter-small');
      } else if (midSmall.includes(game.player.pokemon)) {
        spriteImg.classList.add('mid-small');
      } else if (finalSmall.includes(game.player.pokemon)) {
        spriteImg.classList.add('final-small');
      }
      
      applyPokemonScale(spriteImg, game.player.pokemon, 1.0);
      document.getElementById('player-pokemon-name').textContent = data.name;
      document.getElementById('player-level').textContent = game.player.level;
      document.getElementById('hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
      document.getElementById('exp-display').textContent = `${game.player.exp}/${game.player.expToNext}`;
      document.getElementById('potion-count').textContent = game.player.potions;
      document.getElementById('trophy-count').textContent = game.player.trophies;
      
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      const hpBar = document.getElementById('hp-bar');

      // Atualiza cor da barra baseado na porcentagem
      if (hpPercent > 50) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
      } else if (hpPercent > 20) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
      } else {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
      }
      
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('exp-bar').style.width = expPercent + '%';

      game.player.badges.forEach(badgeIndex => {
        document.getElementById(`badge-${badgeIndex}`).classList.add('earned');
      });
    }

    function applyPokemonScale(imgElement, pokemonName, maxScale = null, offsetX = null, offsetY = null) {
      const data = pokemonData[pokemonName];
      if (data && data.scale) {
        let finalScale = data.scale;
        
        if (maxScale !== null && finalScale > maxScale) {
          finalScale = maxScale;
        }
        
        if (offsetX !== null && offsetY !== null) {
          imgElement.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${finalScale})`;
        } else {
          imgElement.style.transform = `scale(${finalScale})`;
        }
      }
    }

    function applyPokemonScaleInBattle(imgElement, pokemonName, isPlayer = true) {
      const data = pokemonData[pokemonName];
      const scale = data && data.scale ? data.scale : 1;
      const offsetY = data && data.offsetY ? data.offsetY : 0;
      
      imgElement.style.transformOrigin = 'bottom center';
      imgElement.style.transform = `translateY(${offsetY}px) scale(${scale})`;
    }

    function updateGymAvailability() {
      gyms.forEach((gym, index) => {
        const gymEl = document.getElementById(`gym-${index}`);
        const hasRequiredBadges = game.player.badges.length >= index;
        
        gymEl.classList.remove('completed', 'locked');
        
        if (game.player.badges.includes(index)) {
          gymEl.classList.add('completed');
        } else if (hasRequiredBadges && game.player.level >= gym.requiredLevel) {
          // Dispon√≠vel
        } else {
          gymEl.classList.add('locked');
        }
      });

      if (game.player.badges.length === 8) {
        document.getElementById('elite-section').style.display = 'block';
        updateEliteAvailability();
      }
    }

    function updateEliteAvailability() {
      eliteFour.forEach((elite, index) => {
        const eliteEl = document.getElementById(`elite-${index}`);
        const hasRequiredElite = game.player.eliteDefeated.length >= index;
        
        if (game.player.eliteDefeated.includes(index)) {
          eliteEl.classList.add('completed');
          eliteEl.classList.remove('locked');
        } else if (hasRequiredElite && game.player.level >= elite.requiredLevel) {
          eliteEl.classList.remove('locked');
        } else {
          eliteEl.classList.add('locked');
        }
      });
    }

    function calculatePokemonHP(level, type) {
      // Todos usam o mesmo c√°lculo do jogador
      let increment = 15;
      return 15 + ((level - 1) * increment);
    }

    function startTraining() {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });

      const randomPokemon = trainingPokemon[Math.floor(Math.random() * trainingPokemon.length)];
      const level = Math.min(100, Math.max(1, game.player.level - 2 + Math.floor(Math.random() * 5)));
      
      game.trainingOpponent = {
        name: randomPokemon,
        level: level,
        maxHp: calculatePokemonHP(level, 'training'),  // ‚Üê NOVA LINHA
        hp: calculatePokemonHP(level, 'training')       // ‚Üê NOVA LINHA
      };

      game.inBattle = true;
      game.battleType = 'training';

      showScreen('training-screen');
      audioSystem.play('training-music');
      
      const playerData = pokemonData[game.player.pokemon];
      document.getElementById('training-player-sprite').src = playerData.sprite;
      applyPokemonScaleInBattle(document.getElementById('training-player-sprite'), game.player.pokemon, true);
      document.getElementById('training-pokemon-name').textContent = playerData.name;
      document.getElementById('training-level').textContent = game.player.level;
      
      const opponentData = pokemonData[randomPokemon];
      document.getElementById('training-opponent-name').textContent = 'Pokemon Selvagem';
      document.getElementById('training-opponent-pokemon-name').textContent = opponentData.name;
      document.getElementById('training-opponent-level').textContent = level;
      document.getElementById('training-opponent-sprite').src = opponentData.sprite;
      applyPokemonScaleInBattle(document.getElementById('training-opponent-sprite'), randomPokemon, false);
      
      updateTrainingDisplay();
      nextTrainingQuestion();

      document.getElementById('training-potion-count').textContent = game.player.potions;
    }

    function updateTrainingDisplay() {
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('training-exp-bar').style.width = expPercent + '%';
      document.getElementById('training-exp-display').textContent = `${game.player.exp}/${game.player.expToNext}`;
      document.getElementById('training-level').textContent = game.player.level;
      
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      const hpBar = document.getElementById('training-battle-hp-bar');
      document.getElementById('training-battle-hp-display').textContent = `${game.player.hp}/${game.player.maxHp}`;
      
      // Atualiza cor e largura da barra de HP do jogador
      if (hpPercent > 50) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
      } else if (hpPercent > 20) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
      } else {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
      }
      
      if (game.trainingOpponent) {
        const oppHpPercent = (game.trainingOpponent.hp / game.trainingOpponent.maxHp) * 100;
        const oppHpBar = document.getElementById('training-opponent-hp-bar');
        document.getElementById('training-opponent-hp-display').textContent = `${game.trainingOpponent.hp}/${game.trainingOpponent.maxHp}`;
        
        // Atualiza cor e largura da barra de HP do oponente
        if (oppHpPercent > 50) {
          oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
        } else if (oppHpPercent > 20) {
          oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
        } else {
          oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
        }
      }
    }

    function nextTrainingQuestion() {
      if (!currentTrainingQuestion) {
        currentTrainingQuestion = generateQuestion();
      }
      
      updateQuestionCounter();
      document.getElementById('training-question').innerHTML = currentTrainingQuestion.question;
      
      const answersDiv = document.getElementById('training-answers');
      answersDiv.innerHTML = '';
      currentTrainingQuestion.allAnswers.forEach(ans => {
        const btn = document.createElement('button');
        btn.textContent = ans;
        btn.onclick = () => checkTrainingAnswer(ans, currentTrainingQuestion.answer, currentTrainingQuestion.index);
        answersDiv.appendChild(btn);
      });
      
      const potionBtn = document.getElementById('training-potion-btn');
      potionBtn.disabled = game.player.potions === 0;
    }

    function checkTrainingAnswer(selected, correct, questionIndex) {
      // ‚úÖ DESABILITA O BOT√ÉO DE PO√á√ÉO IMEDIATAMENTE (quando alternativa √© clicada)
      document.getElementById('training-potion-btn').disabled = true;

      const messageEl = document.getElementById('training-message');
      const answersDiv = document.getElementById('training-answers');
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      saveGame();
      
      if(selected === correct) {
        markQuestionAsAnswered(questionIndex);
        updateQuestionCounter();
        
        // Calcula dano com base na diferen√ßa de n√≠vel
        const { min: minPercent, max: maxPercent } = calculateDamagePercent(
          game.player.level,           // atacante
          game.trainingOpponent.level  // defensor
        );

        const percentage = minPercent + (Math.random() * (maxPercent - minPercent));
        const damage = Math.floor(game.trainingOpponent.maxHp * percentage);
        // Primeiro, cria uma vari√°vel que verifica se tem explica√ß√£o
        const explanationBtn = currentTrainingQuestion.explanation && currentTrainingQuestion.explanation.trim() !== '' 
          ? `<button onclick="showExplanation(\`${currentTrainingQuestion.explanation.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`)" class="btn-secondary" style="margin-top: 10px; margin-left: 10px;">üìñ Explica√ß√£o</button>` 
          : '';

        // Depois, usa essa vari√°vel no innerHTML
        messageEl.innerHTML = `‚úÖ CORRETO! ${pokemonData[game.player.pokemon].name} vai atacar e causar ${damage} de dano!<br><br><strong>Resposta: ${correct}</strong><br><br>
        <button onclick="continueAfterCorrectTraining(${damage})" class="btn-secondary" style="margin-top: 10px;">Continuar</button>${explanationBtn}`;
        messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
      } else {
        // Primeiro, cria a vari√°vel de verifica√ß√£o
        const explanationBtn = currentTrainingQuestion.explanation && currentTrainingQuestion.explanation.trim() !== '' 
          ? `<button onclick="showExplanation(\`${currentTrainingQuestion.explanation.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`)" class="btn-secondary" style="margin-top: 10px; margin-left: 10px;">üìñ Explica√ß√£o</button>` 
          : '';

        // Depois, usa no innerHTML
        messageEl.innerHTML = `‚ùå ERRADO! A resposta correta era:<br><br><strong>${correct}</strong><br><br>
        <button onclick="continueAfterWrongTraining()" class="btn-primary" style="margin-top: 10px;">Continuar</button>${explanationBtn}`;
        messageEl.style.background = 'rgba(200, 0, 0, 0.9)';
      }

      document.getElementById('training-message').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function continueAfterCorrectTraining(damage) {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });
      const messageEl = document.getElementById('training-message');
      const answersDiv = document.getElementById('training-answers');
      
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      setTimeout(() => {
        game.trainingOpponent.hp = Math.max(0, game.trainingOpponent.hp - damage);
        messageEl.innerHTML = `${pokemonData[game.player.pokemon].name} atacou!`;
        messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
        updateTrainingDisplay();
        currentTrainingQuestion = null;
        
        if(game.trainingOpponent.hp <= 0) {
          showBattleResult(true, 'üéâ VIT√ìRIA! üéâ', `Voc√™ derrotou ${pokemonData[game.trainingOpponent.name].name}!`);
          
          setTimeout(() => {
            if(game.player.level < 100) {
              const expGain = 20 + Math.floor(game.trainingOpponent.level * 3);
              game.player.exp += expGain;
              messageEl.innerHTML = `üéâ VIT√ìRIA! ${pokemonData[game.player.pokemon].name} ganhou ${expGain} EXP!`;
              
              if(game.player.exp >= game.player.expToNext && game.player.level < 100) {
                game.player.level++;
                game.player.exp = 0;
                if(game.player.level >= 100) {
                  game.player.expToNext = 0;
                } else {
                  game.player.expToNext = Math.floor(50 * Math.pow(1.1, game.player.level - 1));
                }
                game.player.maxHp += 15;
                game.player.hp = game.player.maxHp;
                messageEl.innerHTML += `<br>üéâ LEVEL UP! ${pokemonData[game.player.pokemon].name} subiu para o n√≠vel ${game.player.level}!`;
                
                if (checkEvolution()) {
                  messageEl.innerHTML += `<br>‚ú® ${pokemonData[game.player.pokemon].name} est√° pronto para evoluir!`;
                }
                
                updatePlayerDisplay();
                updateGymAvailability();
              }
            } else {
              messageEl.innerHTML = `üéâ VIT√ìRIA! ${pokemonData[game.player.pokemon].name} est√° no n√≠vel m√°ximo!`;
            }
            
            saveGame();
            updateTrainingDisplay();
            
            setTimeout(() => {
              messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
              messageEl.innerHTML = 'Treinamento conclu√≠do! Voltando ao mapa...';
              if (Math.random() < 0.25) {
                if (game.player.potions < MAX_POTIONS) {
                  game.player.potions++;
                  messageEl.innerHTML += '<br>üéÅ Voc√™ ganhou uma Po√ß√£o!';
                  saveGame();
                } else {
                  messageEl.innerHTML += '<br>‚ö†Ô∏è Voc√™ encontrou uma Po√ß√£o, mas seu invent√°rio est√° cheio!';
                }
              }
              setTimeout(() => backToMap(), 2000);
            }, 2000);
          }, 3500);
          return;
        }
        
        setTimeout(() => {
          trainingOpponentAttack();
        }, 1000);
      }, 300);
    }

    function continueAfterWrongTraining() {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });
      const answersDiv = document.getElementById('training-answers');
      
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      setTimeout(() => {
        trainingOpponentAttack();
      }, 300);
    }

    function trainingOpponentAttack() {
      const messageEl = document.getElementById('training-message');

      // Calcula dano com base na diferen√ßa de n√≠vel
      const { min: minPercent, max: maxPercent } = calculateDamagePercent(
        game.trainingOpponent.level, // atacante
        game.player.level             // defensor
      );

      const percentage = minPercent + (Math.random() * (maxPercent - minPercent));
      const damage = Math.floor(game.player.maxHp * percentage);

      game.player.hp = Math.max(0, game.player.hp - damage);
      
      messageEl.innerHTML = `${pokemonData[game.trainingOpponent.name].name} atacou e causou ${damage} de dano!`;
      messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
      
      updateTrainingDisplay();
      
      saveGame();
      
      if(game.player.hp <= 0) {
        showBattleResult(false, 'üíÄ DERROTA! üíÄ', `${pokemonData[game.player.pokemon].name} foi derrotado!`);
        
        setTimeout(() => {
          messageEl.innerHTML = `üíÄ ${pokemonData[game.player.pokemon].name} foi derrotado!<br>Voc√™ voltou ao Centro Pokemon...`;
          game.player.hp = game.player.maxHp;
          saveGame();
          currentTrainingQuestion = null;
          
          setTimeout(() => backToMap(), 3000);
        }, 3500);
        return;
      }
      
      setTimeout(() => {
        messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
        currentTrainingQuestion = null;
        nextTrainingQuestion();
      }, 1500);
    }

    function backToMap() {
      const trainingMessage = document.getElementById('training-message');
      if (trainingMessage) {
        trainingMessage.innerHTML = 'Responda corretamente para atacar o Pokemon selvagem!';
        trainingMessage.style.background = 'rgba(0, 0, 0, 0.9)';
      }
      
      game.inBattle = false;
      game.currentGym = null;
      game.currentElite = null;
      game.currentOpponent = null;
      game.trainingOpponent = null;
      currentTrainingQuestion = null;
      currentBattleQuestion = null;
      
      saveGame();
      
      showScreen('map-screen');
      audioSystem.play('map-music');
      updatePlayerDisplay();
      updateGymAvailability();
      
      if (game.pendingEvolution) {
        setTimeout(() => startEvolution(), 500);
      }
    }

    function challengeGym(gymIndex) {
      const gym = gyms[gymIndex];
      const gymEl = document.getElementById(`gym-${gymIndex}`);
      
      if(gymEl.classList.contains('locked')) {
        alert(`Voc√™ precisa estar no n√≠vel ${gym.requiredLevel} ou superior para desafiar este gin√°sio!`);
        return;
      }
      
      if(game.player.badges.includes(gymIndex)) {
        alert('Voc√™ j√° conquistou este gin√°sio!');
        return;
      }
      
      game.currentGym = gymIndex;
      game.battleType = 'gym';
      
      const pokemonWithHP = gym.pokemon.map(p => {
        const hp = calculatePokemonHP(p.level, 'gym');
        return { ...p, maxHp: hp, hp: hp };
      });
      
      game.currentOpponent = { ...pokemonWithHP[0] };
      game.currentOpponent.index = 0;
      game.currentOpponent.allPokemon = pokemonWithHP;
      game.inBattle = true;
      
      startBattle(gym);
    }

    function challengeElite(eliteIndex) {
      const elite = eliteFour[eliteIndex];
      const eliteEl = document.getElementById(`elite-${eliteIndex}`);
      
      if(eliteEl.classList.contains('locked')) {
        alert(`Voc√™ precisa estar no n√≠vel ${elite.requiredLevel} ou superior!`);
        return;
      }

      if(eliteIndex === 4 && game.player.level < 100) {
        alert('Voc√™ precisa estar no n√≠vel 100 para desafiar o Ash, atual campe√£o!');
        return;
      }
      
      if(game.player.eliteDefeated.includes(eliteIndex)) {
        alert('Voc√™ j√° derrotou este membro da Elite Four!');
        return;
      }
      
      game.currentElite = eliteIndex;
      game.battleType = 'elite';
      
      const hpType = eliteIndex === 4 ? 'ash' : 'elite';
      const pokemonWithHP = elite.pokemon.map(p => {
        const hp = calculatePokemonHP(p.level, hpType);
        return { ...p, maxHp: hp, hp: hp };
      });
      
      game.currentOpponent = { ...pokemonWithHP[0] };
      game.currentOpponent.index = 0;
      game.currentOpponent.allPokemon = pokemonWithHP;
      game.inBattle = true;
      
      startEliteBattle(elite);
    }

    function startBattle(gym) {
      currentBattleSuffix = '-gym-' + game.currentGym;  // ‚Üê ADICIONE ESTA LINHA
      const suffix = currentBattleSuffix;

      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });

      showScreen('battle-screen-gym-' + game.currentGym);
      audioSystem.play('gym-music');
      
      const playerData = pokemonData[game.player.pokemon];
      document.getElementById('battle-player-sprite' + suffix).src = playerData.sprite;
      applyPokemonScaleInBattle(document.getElementById('battle-player-sprite' + suffix), game.player.pokemon, true);
      document.getElementById('battle-player-name' + suffix).textContent = playerData.name;
      document.getElementById('battle-player-level' + suffix).textContent = game.player.level;
      document.getElementById('battle-hp-display' + suffix).textContent = `${game.player.hp}/${game.player.maxHp}`;
      
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      const hpBar = document.getElementById('battle-hp-bar' + suffix);

      if (hpPercent > 50) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
      } else if (hpPercent > 20) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
      } else {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
      }
      
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('battle-exp-bar' + suffix).style.width = expPercent + '%';
      document.getElementById('battle-exp-display' + suffix).textContent = `${game.player.exp}/${game.player.expToNext}`;
      
      const opponentPokemon = pokemonData[game.currentOpponent.name];
      document.getElementById('opponent-name' + suffix).textContent = `L√≠der ${gym.name}`;
      document.getElementById('opponent-pokemon-name' + suffix).textContent = opponentPokemon.name;
      document.getElementById('opponent-level' + suffix).textContent = game.currentOpponent.level;
      document.getElementById('opponent-hp-display' + suffix).textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
      document.getElementById('battle-opponent-sprite' + suffix).src = opponentPokemon.sprite;
      applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite' + suffix), game.currentOpponent.name, false);
      
      const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
      const oppHpBar = document.getElementById('opponent-hp-bar' + suffix);

      if (oppHpPercent > 50) {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
      } else if (oppHpPercent > 20) {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
      } else {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
      }
      
      document.getElementById('battle-message' + suffix).innerHTML = `${gym.name} desafia voc√™ para uma batalha!`;
      document.getElementById('battle-message' + suffix).style.background = 'rgba(0, 0, 0, 0.9)';
      
      nextBattleQuestion();

      document.getElementById('battle-potion-count' + suffix).textContent = game.player.potions;
    }

    function startEliteBattle(elite) {
      currentBattleSuffix = '-elite-' + game.currentElite;  // ‚Üê ADICIONE ESTA LINHA
      const suffix = currentBattleSuffix;

      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });

      showScreen('battle-screen-elite-' + game.currentElite);
      audioSystem.play('elite-music');
      
      const playerData = pokemonData[game.player.pokemon];
      document.getElementById('battle-player-sprite' + suffix).src = playerData.sprite;
      applyPokemonScaleInBattle(document.getElementById('battle-player-sprite' + suffix), game.player.pokemon, true);
      document.getElementById('battle-player-name' + suffix).textContent = playerData.name;
      document.getElementById('battle-player-level' + suffix).textContent = game.player.level;
      document.getElementById('battle-hp-display' + suffix).textContent = `${game.player.hp}/${game.player.maxHp}`;
      
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      const hpBar = document.getElementById('battle-hp-bar' + suffix);

      if (hpPercent > 50) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
      } else if (hpPercent > 20) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
      } else {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
      }
      
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('battle-exp-bar' + suffix).style.width = expPercent + '%';
      document.getElementById('battle-exp-display' + suffix).textContent = `${game.player.exp}/${game.player.expToNext}`;
      
      const opponentPokemon = pokemonData[game.currentOpponent.name];
      document.getElementById('opponent-name' + suffix).textContent = `${elite.name} - ${elite.title}`;
      document.getElementById('opponent-pokemon-name' + suffix).textContent = opponentPokemon.name;
      document.getElementById('opponent-level' + suffix).textContent = game.currentOpponent.level;
      document.getElementById('opponent-hp-display' + suffix).textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
      document.getElementById('battle-opponent-sprite' + suffix).src = opponentPokemon.sprite;
      applyPokemonScaleInBattle(document.getElementById('battle-opponent-sprite' + suffix), game.currentOpponent.name, false);
      
      const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
      const oppHpBar = document.getElementById('opponent-hp-bar' + suffix);

      if (oppHpPercent > 50) {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
      } else if (oppHpPercent > 20) {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
      } else {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
      }
      
      document.getElementById('battle-message' + suffix).innerHTML = `${elite.name} desafia voc√™!`;
      
      nextBattleQuestion();

      document.getElementById('battle-potion-count' + suffix).textContent = game.player.potions;
    }

    function nextBattleQuestion(disableDuringSwitch = false) {
      if (!currentBattleQuestion) {
        currentBattleQuestion = generateQuestion();
      }
      
      updateQuestionCounter();
      document.getElementById('battle-question' + currentBattleSuffix).innerHTML = currentBattleQuestion.question;
      
      const answersDiv = document.getElementById('battle-answers' + currentBattleSuffix);
      answersDiv.innerHTML = '';
      
      currentBattleQuestion.allAnswers.forEach(ans => {
        const btn = document.createElement('button');
        btn.textContent = ans;
        btn.onclick = () => checkBattleAnswer(ans, currentBattleQuestion.answer, currentBattleQuestion.index);
        btn.disabled = disableDuringSwitch;
        answersDiv.appendChild(btn);
      });
      
      // ‚úÖ HABILITA O BOT√ÉO DE PO√á√ÉO (exceto durante troca de Pok√©mon)
      if (!disableDuringSwitch) {
        const potionBtn = document.getElementById('battle-potion-btn' + currentBattleSuffix);
        potionBtn.disabled = game.player.potions === 0;
      }
    }

    function checkBattleAnswer(selected, correct, questionIndex) {
      document.getElementById('battle-potion-btn' + currentBattleSuffix).disabled = true;

      saveGame();
      
      const messageEl = document.getElementById('battle-message' + currentBattleSuffix);
      
      if (game.battleType === 'gym') {
        const gym = gyms[game.currentGym];
        handleBattleLogic(selected, correct, gym, gym.pokemon, 'badges', game.currentGym, questionIndex);
      } else {
        const elite = eliteFour[game.currentElite];
        handleBattleLogic(selected, correct, elite, elite.pokemon, 'eliteDefeated', game.currentElite, questionIndex);
      }
    }

    function handleBattleLogic(selected, correct, opponent, pokemonList, progressType, progressIndex, questionIndex) {
      const messageEl = document.getElementById('battle-message' + currentBattleSuffix);
      
      if(selected === correct) {
        const answersDiv = document.getElementById('battle-answers' + currentBattleSuffix);
        answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
        
        markQuestionAsAnswered(questionIndex);
        updateQuestionCounter();
        
        // Calcula dano com base na diferen√ßa de n√≠vel
        const { min: minPercent, max: maxPercent } = calculateDamagePercent(
          game.player.level,          // atacante
          game.currentOpponent.level  // defensor
        );

        const percentage = minPercent + (Math.random() * (maxPercent - minPercent));
        const damage = Math.floor(game.currentOpponent.maxHp * percentage);
        const explanationBtn = currentBattleQuestion.explanation && currentBattleQuestion.explanation.trim() !== '' 
          ? `<button onclick="showExplanation(\`${currentBattleQuestion.explanation.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`)" class="btn-secondary" style="margin-top: 10px; margin-left: 10px;">üìñ Explica√ß√£o</button>` 
          : '';

        messageEl.innerHTML = `‚úÖ CORRETO! ${pokemonData[game.player.pokemon].name} vai atacar e causar ${damage} de dano!<br><br><strong>Resposta: ${correct}</strong><br><br>
        <button onclick="continueAfterCorrectBattle(${damage}, '${progressType}', ${progressIndex})" class="btn-secondary" style="margin-top: 10px;">Continuar</button>${explanationBtn}`;
        messageEl.style.background = 'rgba(0, 200, 0, 0.9)';

        document.getElementById('battle-message' + currentBattleSuffix).scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        saveGame();
        
      } else {
        const answersDiv = document.getElementById('battle-answers' + currentBattleSuffix);
        answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
        
        const explanationBtn = currentBattleQuestion.explanation && currentBattleQuestion.explanation.trim() !== '' 
          ? `<button onclick="showExplanation(\`${currentBattleQuestion.explanation.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`)" class="btn-secondary" style="margin-top: 10px; margin-left: 10px;">üìñ Explica√ß√£o</button>` 
          : '';

        messageEl.innerHTML = `‚ùå ERRADO! A resposta correta era:<br><br><strong>${correct}</strong><br><br>
        <button onclick="continueAfterWrongBattle()" class="btn-primary" style="margin-top: 10px;">Continuar</button>${explanationBtn}`;
        messageEl.style.background = 'rgba(200, 0, 0, 0.9)';

        document.getElementById('battle-message' + currentBattleSuffix).scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function continueAfterWrongBattle() {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });
      const answersDiv = document.getElementById('battle-answers' + currentBattleSuffix);
      
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      setTimeout(() => {
        opponentAttack();
      }, 300);
    }

    function continueAfterCorrectBattle(damage, progressType, progressIndex) {
      document.querySelector('.container').scrollTo({ top: 0, behavior: 'auto' });
      const messageEl = document.getElementById('battle-message' + currentBattleSuffix);
      const answersDiv = document.getElementById('battle-answers' + currentBattleSuffix);
      
      answersDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
      
      setTimeout(() => {
        game.currentOpponent.hp = Math.max(0, game.currentOpponent.hp - damage);
        messageEl.innerHTML = `${pokemonData[game.player.pokemon].name} atacou!`;
        messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
        
        updateBattleDisplay();
        saveGame();
        
        const opponent = game.battleType === 'gym' ? gyms[game.currentGym] : eliteFour[game.currentElite];
        const pokemonList = game.currentOpponent.allPokemon;
        
        if(game.currentOpponent.hp <= 0) {
          const defeatedPokemonIndex = game.currentOpponent.index;
          game.currentOpponent.index++;
          
          if(game.currentOpponent.index < pokemonList.length) {
            const defeatedPokemon = pokemonList[defeatedPokemonIndex];
            
            let leveledUp = false;
            if(game.player.level < 100) {
              const expGain = 15 + Math.floor(defeatedPokemon.level * 6);
              game.player.exp += expGain;

              while(game.player.exp >= game.player.expToNext && game.player.level < 100) {
                game.player.level++;
                game.player.exp -= game.player.expToNext;
                if(game.player.level >= 100) {
                  game.player.expToNext = 0;
                } else {
                  game.player.expToNext = Math.floor(50 * Math.pow(1.1, game.player.level - 1));
                }
                game.player.maxHp += 15;
                leveledUp = true;
              }

              if (leveledUp) {
                game.player.hp = game.player.maxHp;
                checkEvolution();
              }
            }

            updateBattleDisplay();
            saveGame();
            
            setTimeout(() => {
              const opponentSprite = document.getElementById('battle-opponent-sprite' + currentBattleSuffix);
              opponentSprite.style.transition = 'opacity 0.5s';
              opponentSprite.style.opacity = '0';
              if(game.player.level < 100) {
                const expGain = 15 + Math.floor(defeatedPokemon.level * 6);
                messageEl.innerHTML = `${pokemonData[defeatedPokemon.name].name} foi derrotado!<br>${pokemonData[game.player.pokemon].name} ganhou ${expGain} EXP!`;
                if (leveledUp) {
                  messageEl.innerHTML += `<br>üéâ LEVEL UP! ${pokemonData[game.player.pokemon].name} subiu para o n√≠vel ${game.player.level}!`;
                }
              } else {
                messageEl.innerHTML = `${pokemonData[defeatedPokemon.name].name} foi derrotado!<br>${pokemonData[game.player.pokemon].name} est√° no n√≠vel m√°ximo!`;
              }
              messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
              
              setTimeout(() => {
                currentBattleQuestion = null;
                const nextPokemonIndex = game.currentOpponent.index;
                const nextPokemon = pokemonList[nextPokemonIndex];
                
                messageEl.innerHTML = `${opponent.name} enviou ${pokemonData[nextPokemon.name].name}!`;
                messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
                
                game.currentOpponent = { ...nextPokemon };
                game.currentOpponent.index = nextPokemonIndex;
                game.currentOpponent.allPokemon = pokemonList;
                
                saveGame();
                
                if (game.battleType === 'gym') {
                  startBattle(opponent);
                } else {
                  startEliteBattle(opponent);
                }
                
                nextBattleQuestion(true);  // ‚Üê APENAS isso (bloqueia alternativas)
                
                setTimeout(() => {
                  const opponentSprite = document.getElementById('battle-opponent-sprite' + currentBattleSuffix);
                  opponentSprite.style.transition = 'opacity 0.5s';
                  opponentSprite.style.opacity = '0';
                  
                  setTimeout(() => {
                    opponentSprite.style.opacity = '1';
                    
                    setTimeout(() => {
                      document.getElementById('battle-potion-btn' + currentBattleSuffix).disabled = false;
                      nextBattleQuestion(false);  // ‚Üê APENAS isso (desbloqueia alternativas)
                    }, 600);
                  }, 1000);
                }, 1000);

              }, 1500);
            }, 1500);
            
            return;
          } else {
            const lastDefeatedPokemon = pokemonList[defeatedPokemonIndex];
            
            showBattleResult(true, 'üèÜ VIT√ìRIA COMPLETA! üèÜ', `Voc√™ derrotou ${opponent.name}!`);
            
            setTimeout(() => {
              let leveledUp = false;
              
              if(game.player.level < 100) {
                const lastExpGain = 15 + Math.floor(lastDefeatedPokemon.level * 6);
                game.player.exp += lastExpGain;
                
                while(game.player.exp >= game.player.expToNext && game.player.level < 100) {
                  game.player.level++;
                  game.player.exp -= game.player.expToNext;
                  if(game.player.level >= 100) {
                    game.player.expToNext = 0;
                  } else {
                    game.player.expToNext = Math.floor(50 * Math.pow(1.1, game.player.level - 1));
                  }
                  game.player.maxHp += 15;
                  leveledUp = true;
                }
                
                if (leveledUp) {
                  game.player.hp = game.player.maxHp;
                  checkEvolution();
                }
              }
              
              updateBattleDisplay();
              saveGame();
              
              if(game.player.level < 100) {
                const lastExpGain = 15 + Math.floor(lastDefeatedPokemon.level * 6);
                messageEl.innerHTML = `${pokemonData[lastDefeatedPokemon.name].name} foi derrotado!<br>${pokemonData[game.player.pokemon].name} ganhou ${lastExpGain} EXP!`;
                if (leveledUp) {
                  messageEl.innerHTML += `<br>üéâ LEVEL UP! ${pokemonData[game.player.pokemon].name} subiu para o n√≠vel ${game.player.level}!`;
                }
              } else {
                messageEl.innerHTML = `${pokemonData[lastDefeatedPokemon.name].name} foi derrotado!<br>${pokemonData[game.player.pokemon].name} est√° no n√≠vel m√°ximo!`;
              }
              messageEl.style.background = 'rgba(0, 200, 0, 0.9)';
              
              setTimeout(() => {
                game.player[progressType].push(progressIndex);
                
                let leveledUpBonus = false;

                if(game.player.level < 100) {
                  const expBonus = progressType === 'badges' ? 100 + (progressIndex * 50) : 200 + (progressIndex * 100);
                  game.player.exp += expBonus;

                  while(game.player.exp >= game.player.expToNext && game.player.level < 100) {
                    game.player.level++;
                    game.player.exp -= game.player.expToNext;
                    if(game.player.level >= 100) {
                      game.player.expToNext = 0;
                    } else {
                      game.player.expToNext = Math.floor(50 * Math.pow(1.1, game.player.level - 1));
                    }
                    game.player.maxHp += 15;
                    leveledUpBonus = true;
                  }
                }
                
                game.player.hp = game.player.maxHp;
                
                if (leveledUpBonus) {
                  checkEvolution();
                }
                
                updateBattleDisplay();
                saveGame();
                currentBattleQuestion = null;
                
                if (progressType === 'eliteDefeated' && progressIndex === 4) {
                  game.player.trophies++;
                  saveTrophies();
                  showScreen('victory-screen');
                  audioSystem.stopAll();
                } else {
                  const badge = progressType === 'badges' ? opponent.badge : `${opponent.name} derrotado`;
                  if(game.player.level < 100) {
                    const expBonus = progressType === 'badges' ? 100 + (progressIndex * 50) : 200 + (progressIndex * 100);
                    messageEl.innerHTML = `üèÜ VIT√ìRIA COMPLETA! Voc√™ conquistou ${badge}!<br>Ganhou ${expBonus} EXP de b√¥nus!`;
                    if (leveledUpBonus) {
                      messageEl.innerHTML += `<br>üéâ LEVEL UP! ${pokemonData[game.player.pokemon].name} subiu para o n√≠vel ${game.player.level}!`;
                    }
                  } else {
                    messageEl.innerHTML = `üèÜ VIT√ìRIA COMPLETA! Voc√™ conquistou ${badge}!<br>${pokemonData[game.player.pokemon].name} est√° no n√≠vel m√°ximo!`;
                  }
                  messageEl.style.background = 'rgba(255, 215, 0, 0.9)';
                  
                  setTimeout(() => {
                    game.inBattle = false;
                    backToMap();
                  }, 3000);
                }
              }, 2000);
            }, 3500);
            return;
          }
        }
        
        setTimeout(() => opponentAttack(), 1500);
      }, 300);
    }

    function showExplanation(explanation) {
      if (!explanation || explanation.trim() === '') {
        alert('N√£o h√° explica√ß√£o dispon√≠vel para esta quest√£o.');
        return;
      }
      
      document.getElementById('explanation-text').innerHTML = explanation;
      document.getElementById('explanation-modal').classList.add('active');
    }

    function closeExplanationModal() {
      document.getElementById('explanation-modal').classList.remove('active');
    }

    function opponentAttack() {
      const messageEl = document.getElementById('battle-message' + currentBattleSuffix);

      // Calcula dano com base na diferen√ßa de n√≠vel
      const { min: minPercent, max: maxPercent } = calculateDamagePercent(
        game.currentOpponent.level, // atacante
        game.player.level            // defensor
      );

      const percentage = minPercent + (Math.random() * (maxPercent - minPercent));
      const damage = Math.floor(game.player.maxHp * percentage);

      game.player.hp = Math.max(0, game.player.hp - damage);
      currentBattleQuestion = null;
      
      messageEl.innerHTML = `${pokemonData[game.currentOpponent.name].name} atacou e causou ${damage} de dano!`;
      messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
      
      updateBattleDisplay();
      
      saveGame();
      
      if(game.player.hp <= 0) {
        showBattleResult(false, 'üíÄ DERROTA! üíÄ', `${pokemonData[game.player.pokemon].name} foi derrotado!`);
        
        setTimeout(() => {
          messageEl.innerHTML = `üíÄ ${pokemonData[game.player.pokemon].name} foi derrotado!<br>Voc√™ voltou ao Centro Pokemon...`;
          game.player.hp = game.player.maxHp;
          game.inBattle = false;
          saveGame();
          
          setTimeout(() => backToMap(), 3000);
        }, 3500);
        return;
      }
      
      setTimeout(() => {
        messageEl.style.background = 'rgba(0, 0, 0, 0.9)';
        nextBattleQuestion();
      }, 1500);
    }

   function updateBattleDisplay() {
      const hpPercent = (game.player.hp / game.player.maxHp) * 100;
      const hpBar = document.getElementById('battle-hp-bar' + currentBattleSuffix);
      document.getElementById('battle-hp-display' + currentBattleSuffix).textContent = `${game.player.hp}/${game.player.maxHp}`;
      
      // Atualiza cor e largura da barra de HP do jogador
      if (hpPercent > 50) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
      } else if (hpPercent > 20) {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
      } else {
        hpBar.style.cssText = `width: ${hpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
      }
      
      const oppHpPercent = (game.currentOpponent.hp / game.currentOpponent.maxHp) * 100;
      const oppHpBar = document.getElementById('opponent-hp-bar' + currentBattleSuffix);
      document.getElementById('opponent-hp-display' + currentBattleSuffix).textContent = `${game.currentOpponent.hp}/${game.currentOpponent.maxHp}`;
      
      // Atualiza cor e largura da barra de HP do oponente
      if (oppHpPercent > 50) {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #00ff00, #00cc00);`;
      } else if (oppHpPercent > 20) {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ffff00, #ff9900);`;
      } else {
        oppHpBar.style.cssText = `width: ${oppHpPercent}%; background: linear-gradient(to right, #ff0000, #cc0000);`;
      }
      
      const expPercent = (game.player.exp / game.player.expToNext) * 100;
      document.getElementById('battle-exp-bar' + currentBattleSuffix).style.width = expPercent + '%';
      document.getElementById('battle-exp-display' + currentBattleSuffix).textContent = `${game.player.exp}/${game.player.expToNext}`;
    }

    document.addEventListener('click', function() {
      if (audioSystem.currentAudio) {
        // Para qualquer outro √°udio que possa estar tocando por engano
        const allAudios = ['map-music', 'training-music', 'gym-music', 'elite-music'];
        allAudios.forEach(id => {
          if (id !== audioSystem.currentAudio) {
            const otherAudio = document.getElementById(id);
            if (otherAudio && !otherAudio.paused) {
              otherAudio.pause();
              otherAudio.currentTime = 0;
            }
          }
        });
        
        // Toca o √°udio correto
        const audio = document.getElementById(audioSystem.currentAudio);
        if (audio && audio.paused) {
          audio.play().catch(() => {});
          audioSystem.fadeIn(audio);
        }
      }
    });

    function exportSave() {
      const saveData = localStorage.getItem('pokemonYellowSave');
      const usedQuestions = localStorage.getItem('pokemonYellowUsedQuestions');
      const trophies = localStorage.getItem('pokemonTrophies');  // ‚Üê LINHA NOVA
      
      if (!saveData) {
        alert('Nenhum progresso para exportar!');
        return;
      }
      
      const exportData = {
        save: saveData,
        questions: usedQuestions,
        trophies: trophies  // ‚Üê LINHA NOVA
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'pokemonsave.txt';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      alert('Save exportado com sucesso! Arquivo: pokemonsave.txt');
    }

    function importSave() {
      document.getElementById('file-input').click();
    }

    function loadSaveFile(event) {
      const file = event.target.files[0];
      
      if (!file) return;
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const importData = JSON.parse(e.target.result);
          
          if (importData.save) {
            localStorage.setItem('pokemonYellowSave', importData.save);
          }
          
          if (importData.questions) {
            localStorage.setItem('pokemonYellowUsedQuestions', importData.questions);
          }
          
          if (importData.trophies) {  // ‚Üê BLOCO NOVO
            localStorage.setItem('pokemonTrophies', importData.trophies);
          }
          
          alert('Save importado com sucesso! A p√°gina ser√° recarregada.');
          location.reload();
          
        } catch (error) {
          alert('Erro ao importar save! Arquivo inv√°lido.');
        }
      };
      
      reader.readAsText(file);
      
      event.target.value = '';
    }

  </script>
</body>
</html>